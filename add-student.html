<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registry | Shule ERP</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Compact UI Adjustments */
        body { font-size: 14px; background: #f0f2f5; }
        .dashboard-container { max-width: 1200px; margin: auto; padding: 10px; }
        
        .admin-header { 
            display: flex; justify-content: space-between; align-items: center; 
            background: white; padding: 10px 20px; border-radius: 6px; 
            margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Compact Form Grid */
        .form-section { 
            background: #fff; padding: 15px; border-radius: 6px; 
            margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
        }
        .input-grid { 
            display: grid; grid-template-columns: 2fr 1fr 1.5fr auto; 
            gap: 12px; align-items: end; 
        }
        .input-group label { display: block; font-weight: bold; margin-bottom: 4px; font-size: 12px; color: #555; }
        input, select { 
            width: 100%; padding: 6px 10px; border: 1px solid #ccc; 
            border-radius: 4px; font-size: 14px; box-sizing: border-box;
        }

        /* Minimized Table Rows */
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 6px; overflow: hidden; }
        th { background: #0d6efd; color: white; font-weight: 500; text-align: left; padding: 8px 12px; font-size: 13px; }
        td { 
            padding: 6px 12px; border-bottom: 1px solid #eee; 
            font-size: 13px; color: #333; 
        }
        tr:hover { background-color: #f8f9fa; }

        /* Action Buttons */
        .btn { padding: 4px 10px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px; text-decoration: none; display: inline-block; }
        .btn-add { background: #198754; color: white; padding: 8px 20px; }
        .btn-edit { background: #ffc107; color: #000; margin-right: 5px; }
        .btn-view { background: #0dcaf0; color: white; margin-right: 5px; }
        .btn-del { background: #dc3545; color: white; }

        /* Access Control */
        #lock-screen { display: none; position: fixed; inset: 0; background: white; z-index: 999; text-align: center; padding-top: 100px; }
    </style>
</head>
<body>

<div id="lock-screen">
    <h1>üö´ Access Denied</h1>
    <p>Please log in as an administrator.</p>
    <a href="index.html">Go to Login</a>
</div>

<nav style="padding: 10px 20px; background: #333; color: white;">
    <a href="dashboard.html" style="color: white; text-decoration: none;">üè† Dashboard</a>
</nav>

<div class="dashboard-container" id="main-content">
    
    <div class="admin-header">
        <h3 style="margin:0;">Student Registry</h3>
        <span style="font-size: 12px; background: #e7f1ff; color: #0d6efd; padding: 4px 8px; border-radius: 4px; font-weight: bold;">ADMIN PANEL</span>
    </div>

    <div class="form-section">
        <div class="input-grid">
            <div class="input-group">
                <label>Full Name</label>
                <input type="text" id="newName" placeholder="e.g. Agness Likinjiye">
            </div>
            <div class="input-group">
                <label>Sex</label>
                <select id="newSex">
                    <option value="M">Male (M)</option>
                    <option value="F">Female (F)</option>
                </select>
            </div>
            <div class="input-group">
                <label>Class (Kidato)</label>
                <select id="newClass">
                    <option value="Form 1">Form 1</option>
                    <option value="Form 2">Form 2</option>
                    <option value="Form 3">Form 3</option>
                    <option value="Form 4">Form 4</option>
                </select>
            </div>
            <button id="addBtn" class="btn btn-add">Add Student</button>
        </div>
    </div>

    <div class="form-section">
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <input type="text" id="searchInput" placeholder="Search by name..." style="flex: 2;">
            <select id="filterClass" style="flex: 1;">
                <option value="All">All Classes</option>
                <option value="Form 1">Form 1</option>
                <option value="Form 2">Form 2</option>
                <option value="Form 3">Form 3</option>
                <option value="Form 4">Form 4</option>
            </select>
            <button onclick="window.print()" class="btn" style="background:#6c757d; color:white;">Print List</button>
        </div>

        <table>
            <thead>
                <tr>
                    <th style="width: 40px;">S/N</th>
                    <th>Full Name</th>
                    <th style="width: 60px;">Sex</th>
                    <th style="width: 100px;">Class</th>
                    <th style="width: 220px; text-align: center;">Actions</th>
                </tr>
            </thead>
            <tbody id="studentTableBody">
                <tr><td colspan="5" style="text-align:center;">Fetching data...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script type="module">
    import { db } from "./firebase.js";
    import { collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // SECURITY CHECK
    if (sessionStorage.getItem("role") !== "admin") {
        document.getElementById("main-content").style.display = "none";
        document.getElementById("lock-screen").style.display = "block";
    }

    const studentCol = collection(db, "students");
    let allStudents = [];

    async function fetchStudents() {
        try {
            const snap = await getDocs(studentCol);
            allStudents = snap.docs.map(sDoc => ({ id: sDoc.id, ...sDoc.data() }));
            allStudents.sort((a, b) => (a.name || "").localeCompare(b.name || ""));
            renderTable();
        } catch (e) { console.error(e); }
    }

    function renderTable() {
        const tbody = document.getElementById("studentTableBody");
        const filter = document.getElementById("filterClass").value;
        const search = document.getElementById("searchInput").value.toLowerCase();
        
        tbody.innerHTML = "";
        let count = 1;

        const filtered = allStudents.filter(s => {
            return (filter === "All" || s.cls === filter) && (s.name || "").toLowerCase().includes(search);
        });

        filtered.forEach(s => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${count++}</td>
                <td style="font-weight:500;">${s.name}</td>
                <td>${s.sex}</td>
                <td>${s.cls}</td>
                <td style="text-align: center;">
                    <a href="view-report.html?id=${s.id}" class="btn btn-view">Report</a>
                    <button class="btn btn-edit" data-id="${s.id}" data-name="${s.name}">Edit</button>
                    <button class="btn btn-del" data-id="${s.id}">Delete</button>
                </td>
            `;
            tbody.appendChild(row);
        });

        attachListeners();
    }

    // ADD
    document.getElementById("addBtn").onclick = async () => {
        const name = document.getElementById("newName").value.trim();
        const sex = document.getElementById("newSex").value;
        const cls = document.getElementById("newClass").value;
        if(!name) return alert("Name required");
        await addDoc(studentCol, { name, sex, cls, createdAt: new Date() });
        document.getElementById("newName").value = "";
        fetchStudents();
    };

    function attachListeners() {
        document.querySelectorAll(".btn-del").forEach(btn => {
            btn.onclick = async () => {
                if(confirm("Delete student?")) {
                    await deleteDoc(doc(db, "students", btn.dataset.id));
                    fetchStudents();
                }
            };
        });
        document.querySelectorAll(".btn-edit").forEach(btn => {
            btn.onclick = async () => {
                const newN = prompt("New name:", btn.dataset.name);
                if(newN) {
                    await updateDoc(doc(db, "students", btn.dataset.id), { name: newN });
                    fetchStudents();
                }
            };
        });
    }

    document.getElementById("searchInput").oninput = renderTable;
    document.getElementById("filterClass").onchange = renderTable;
    fetchStudents();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Olmoti Secondary</title>
    <style>
        :root { --nav-blue: #1a237e; --nav-hover: #283593; --gold: #c5a059; --bg: #f4f7f6; --sidebar-width: 250px; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; display: flex; background: var(--bg); color: #333; }
        
        /* SIDEBAR */
        .sidebar { width: var(--sidebar-width); background: var(--nav-blue); color: white; height: 100vh; position: fixed; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        .sidebar-header { padding: 25px; text-align: center; border-bottom: 1px solid var(--gold); }
        .nav-links { list-style: none; padding: 0; margin: 0; }
        .nav-links li a { display: block; padding: 15px 20px; color: #ccc; text-decoration: none; border-bottom: 1px solid rgba(255,255,255,0.1); transition: 0.3s; }
        .nav-links li a:hover, .nav-links li a.active { background: var(--nav-hover); color: white; border-left: 5px solid var(--gold); }

        /* CONTENT */
        .main-content { margin-left: var(--sidebar-width); padding: 40px; flex-grow: 1; width: calc(100% - var(--sidebar-width)); }
        .welcome-banner { background: var(--nav-blue); color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-decoration: none; color: inherit; transition: 0.3s; border-top: 4px solid var(--gold); }
        .card:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        
        /* ANALYSIS STYLES */
        .pass-rate-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .pass-card { background: white; padding: 20px; border-radius: 10px; text-align: center; border-bottom: 4px solid #ddd; }
        .pass-card h4 { margin: 0 0 10px; color: #666; font-size: 14px; }
        .pass-card .val { font-size: 28px; font-weight: bold; color: var(--nav-blue); }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header"><h2>OLMOTI SEC</h2><small>Admin Portal</small></div>
        <ul class="nav-links">
            <li><a href="dashboard.html" class="active">ğŸ  Dashboard</a></li>
            <li><a href="students-list.html">ğŸ‘¥ Students</a></li>
            <li><a href="mark-entry.html">ğŸ“ Mark Entry</a></li>
            <li><a href="users-list.html">ğŸ‘¨â€ğŸ« Staff/Users</a></li>
            <li><a href="broadsheet.html">ğŸ“Š Broadsheet</a></li>
            <li><a href="bulk-upload.html">ğŸ“¤ Bulk Upload</a></li>
        </ul>
        <div style="padding: 20px; position: absolute; bottom: 0; width: 100%; box-sizing: border-box;">
            <a href="index.html" style="color: #ff8a80; text-decoration: none; font-weight: bold;">Logout ğŸšª</a>
        </div>
    </div>

    <div class="main-content">
        <div class="welcome-banner">
            <h1>Welcome, Olmoti Portal</h1>
            <p>Monitor school performance and manage academic records efficiently.</p>
        </div>

        <h3 style="color: var(--nav-blue);">School-wide Pass Rate (A-C)</h3>
        <div class="pass-rate-grid" id="passGrid">
            <div class="pass-card">Loading stats...</div>
        </div>

        <h3 style="color: var(--nav-blue);">Management Tools</h3>
        <div class="grid">
            <a href="students-list.html" class="card">
                <h3>ğŸ‘¥ Students</h3>
                <p>View, search, and edit student profiles.</p>
            </a>
            <a href="mark-entry.html" class="card">
                <h3>ğŸ“ Mark Entry</h3>
                <p>Enter scores for Tests, Mid-Term, and Exams.</p>
            </a>
            <a href="users-list.html" class="card">
                <h3>ğŸ‘¨â€ğŸ« Staff Management</h3>
                <p>Monitor logins and reset teacher passwords.</p>
            </a>
            <a href="broadsheet.html" class="card">
                <h3>ğŸ“Š Broadsheet</h3>
                <p>Generate class master sheets and exports.</p>
            </a>
        </div>
    </div>

    <script type="module">
        import { db } from "./firebase.js";
        import { collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        async function loadStats() {
            const grid = document.getElementById('passGrid');
            try {
                const [studSnap, resSnap] = await Promise.all([
                    getDocs(collection(db, "students")),
                    getDocs(collection(db, "results"))
                ]);

                const studentMap = {};
                studSnap.forEach(doc => studentMap[doc.id] = doc.data().cls);

                let stats = {
                    "Form 1": { total: 0, pass: 0 }, "Form 2": { total: 0, pass: 0 },
                    "Form 3": { total: 0, pass: 0 }, "Form 4": { total: 0, pass: 0 }
                };

                resSnap.forEach(doc => {
                    const data = doc.data();
                    const cls = studentMap[data.studentId];
                    if (cls && stats[cls]) {
                        stats[cls].total++;
                        if (['A', 'B', 'C'].includes(data.grade)) stats[cls].pass++;
                    }
                });

                grid.innerHTML = "";
                Object.entries(stats).forEach(([cls, data]) => {
                    const rate = data.total > 0 ? Math.round((data.pass / data.total) * 100) : 0;
                    grid.innerHTML += `
                        <div class="pass-card" style="border-color: ${rate > 50 ? '#2e7d32' : '#d32f2f'}">
                            <h4>${cls}</h4>
                            <div class="val">${rate}%</div>
                            <small>${data.pass} / ${data.total} Passed</small>
                        </div>`;
                });
            } catch (e) {
                grid.innerHTML = "Error loading statistics.";
            }
        }
        loadStats();
    </script>
</body>
</html>

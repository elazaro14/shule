<script type="module">
    import { db, auth } from "./firebase.js"; // Make sure auth is exported from firebase.js
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Wait for the user to be logged in before fetching data
    onAuthStateChanged(auth, (user) => {
        if (user) {
            console.log("User authenticated, loading data...");
            updateDashboard();
        } else {
            console.warn("No user logged in. Redirecting to login...");
            window.location.href = "index.html"; 
        }
    });

    async function updateDashboard() {
        try {
            const studentSnap = await getDocs(collection(db, "students"));
            let total = 0, males = 0, females = 0;

            studentSnap.forEach((doc) => {
                const data = doc.data();
                total++;
                const s = (data.sex || "").toString().toUpperCase();
                if (s === "M") males++;
                if (s === "F") females++;
            });

            document.getElementById("totalStuds").innerText = total;
            document.getElementById("maleStuds").innerText = males;
            document.getElementById("femaleStuds").innerText = females;
            
            // For teachers: Since your rule only allows users to read THEIR OWN doc, 
            // you might need to change your 'users' rule to allow 'admin' to read all users
            // to get a total teacher count.
        } catch (error) {
            console.error("Dashboard Error:", error);
        }
    }
</script>

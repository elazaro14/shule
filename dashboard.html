<script type="module">
    import { db, auth } from "./firebase.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // 1. Monitor Authentication State
    onAuthStateChanged(auth, (user) => {
        if (user) {
            console.log("Logged in as:", user.email);
            loadSchoolStats();
        } else {
            // Redirect to login if user isn't logged in
            window.location.href = "index.html"; 
        }
    });

    async function loadSchoolStats() {
        try {
            const querySnapshot = await getDocs(collection(db, "students"));
            let total = 0, males = 0, females = 0;

            querySnapshot.forEach((doc) => {
                const data = doc.data();
                total++;
                
                // Counting based on the "sex" field (case-insensitive)
                const s = (data.sex || "").toString().toUpperCase();
                if (s === "M" || s === "MALE") males++;
                if (s === "F" || s === "FEMALE") females++;
            });

            // Update your UI elements
            document.getElementById("totalStuds").innerText = total;
            document.getElementById("maleStuds").innerText = males;
            document.getElementById("femaleStuds").innerText = females;

        } catch (error) {
            console.error("Dashboard Load Error:", error);
            if(error.code === "permission-denied") {
                alert("You don't have permission to view student data.");
            }
        }
    }
</script>

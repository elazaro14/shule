<script type="module">
    import { db } from "./firebase.js";
    import { collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    async function updateDashboard() {
        try {
            const studentSnap = await getDocs(collection(db, "students"));
            let total = 0;
            let males = 0;
            let females = 0;

            studentSnap.forEach((doc) => {
                const data = doc.data();
                total++;

                // Robust Sex Checking (handles "F", "f", "Female", etc.)
                const sexValue = (data.sex || "").toString().toUpperCase();
                
                if (sexValue.startsWith("M")) {
                    males++;
                } else if (sexValue.startsWith("F")) {
                    females++;
                }
            });

            // Fallback for Teachers
            const teacherSnap = await getDocs(collection(db, "users"));
            const teacherCount = teacherSnap.size;

            // Update the UI
            document.getElementById("totalStuds").innerText = total;
            document.getElementById("maleStuds").innerText = males;
            document.getElementById("femaleStuds").innerText = females;
            document.getElementById("totalTeachers").innerText = teacherCount;
            
            document.getElementById("dateDisplay").innerText = new Date().toLocaleDateString('en-GB', {
                day: 'numeric', month: 'long', year: 'numeric'
            });

        } catch (error) {
            console.error("Dashboard Error:", error);
            // This will alert if the "Permissions" fix from the previous step wasn't published
            if (error.code === 'permission-denied') {
                alert("Please check your Firebase Rules - Permissions Denied.");
            }
        }
    }

    updateDashboard();
</script>

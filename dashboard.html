<script type="module">
    import { db, auth } from "./firebase.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // SECURITY CHECK: Only load data if user is logged in
    onAuthStateChanged(auth, (user) => {
        if (user) {
            console.log("Logged in:", user.email);
            calculateStats();
        } else {
            window.location.href = "index.html";
        }
    });

    async function calculateStats() {
        try {
            // Collection name must be exactly 'students' in Firebase
            const querySnapshot = await getDocs(collection(db, "students"));
            
            let total = 0, males = 0, females = 0;

            querySnapshot.forEach((doc) => {
                const data = doc.data();
                total++;

                // Looks for 'sex' field. Case-insensitive (M/m or F/f)
                const gender = (data.sex || "").toString().toUpperCase();
                if (gender.startsWith("M")) males++;
                else if (gender.startsWith("F")) females++;
            });

            // Update your HTML elements
            document.getElementById("totalStuds").innerText = total;
            document.getElementById("maleStuds").innerText = males;
            document.getElementById("femaleStuds").innerText = females;

        } catch (error) {
            console.error("Dashboard Error:", error);
            // If you see 'Permission Denied' here, your Firestore Rules are wrong
        }
    }
</script>

<script type="module">
    import { db } from "./firebase.js";
    import { collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    async function initializeDashboard() {
        try {
            // Parallel Fetch for Speed
            const [studSnap, resSnap, userSnap] = await Promise.all([
                getDocs(collection(db, "students")),
                getDocs(collection(db, "results")),
                getDocs(collection(db, "users"))
            ]);

            // --- 1. POPULATION COUNTS (GENDER-SPECIFIC) ---
            let sM = 0, sF = 0, tM = 0, tF = 0;
            const studentData = {};

            studSnap.forEach(doc => {
                const data = doc.data();
                if (data.gender === "M") sM++; else if (data.gender === "F") sF++;
                studentData[doc.id] = { cls: data.cls, grades: [] };
            });

            userSnap.forEach(doc => {
                const data = doc.data();
                // Assumes users with role teacher/admin are counted as teachers
                if (data.role === "teacher" || data.role === "admin") {
                    if (data.gender === "M") tM++; else if (data.gender === "F") tF++;
                }
            });

            // Update Header Stats
            document.getElementById('studStats').innerHTML = `Total: ${sM + sF} (M: ${sM} | F: ${sF})`;
            document.getElementById('teachStats').innerHTML = `Total: ${tM + tF} (M: ${tM} | F: ${tF})`;

            // --- 2. DIVISION ANALYSIS (NECTA BEST 7) ---
            resSnap.forEach(doc => {
                const r = doc.data();
                if (studentData[r.studentId]) studentData[r.studentId].grades.push(r.grade);
            });

            const classSummary = {
                "Form 1": {I:0, II:0, III:0, IV:0, 0:0}, "Form 2": {I:0, II:0, III:0, IV:0, 0:0},
                "Form 3": {I:0, II:0, III:0, IV:0, 0:0}, "Form 4": {I:0, II:0, III:0, IV:0, 0:0}
            };

            Object.values(studentData).forEach(student => {
                if (student.grades.length < 1) return;

                // Map A=1, B=2, C=3, D=4, F=5 and sort ascending
                const pts = student.grades.map(g => {
                    const grade = g.toUpperCase();
                    return grade==='A'?1 : grade==='B'?2 : grade==='C'?3 : grade==='D'?4 : 5;
                }).sort((a,b) => a-b);

                const totalPoints = pts.slice(0, 7).reduce((a, b) => a + b, 0);

                let div = "0";
                if (totalPoints >= 7 && totalPoints <= 17) div = "I";
                else if (totalPoints <= 21) div = "II";
                else if (totalPoints <= 25) div = "III";
                else if (totalPoints <= 33) div = "IV";

                if (classSummary[student.cls]) classSummary[student.cls][div]++;
            });

            // Render Division Cards
            const grid = document.getElementById('passGrid');
            grid.innerHTML = "";
            Object.entries(classSummary).forEach(([form, d]) => {
                grid.innerHTML += `
                    <div class="card">
                        <h3>${form}</h3>
                        <div class="div-row"><span>I:</span> <b>${d.I}</b></div>
                        <div class="div-row"><span>II:</span> <b>${d.II}</b></div>
                        <div class="div-row"><span>III:</span> <b>${d.III}</b></div>
                        <div class="div-row"><span>IV:</span> <b>${d.IV}</b></div>
                        <div class="div-row"><span>0:</span> <b>${d['0']}</b></div>
                    </div>`;
            });

        } catch (err) { console.error(err); }
    }
    initializeDashboard();
</script>>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Olmoti Dashboard | Assignment Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #1a237e; --gold: #c5a059; --bg: #f4f7f6; --white: #ffffff; --danger: #d32f2f; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; display: flex; background: var(--bg); min-height: 100vh; flex-direction: column; }
        
        .sidebar { width: 260px; background: #1a1c23; color: white; height: 100vh; position: fixed; z-index: 1000; }
        .sidebar-header { padding: 30px 20px; text-align: center; border-bottom: 1px solid var(--gold); }
        .nav-links { list-style: none; padding: 20px 0; margin: 0; }
        .nav-links li a { color: #cfd8dc; text-decoration: none; padding: 15px 25px; display: block; transition: 0.3s; }
        .nav-links li.active a { background: rgba(255,255,255,0.1); border-left: 5px solid var(--gold); }

        .main-content { margin-left: 260px; padding: 40px; width: calc(100% - 260px); box-sizing: border-box; flex-grow: 1; }
        
        .admin-box { background: var(--white); border-radius: 12px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; vertical-align: top; font-size: 13px; }
        
        .task-tag { 
            display: inline-flex; align-items: center; background: #e8eaf6; color: #3f51b5; 
            padding: 4px 8px; border-radius: 4px; margin: 3px; font-size: 11px; font-weight: bold; border: 1px solid #c5cae9;
        }
        .task-tag.ct { background: #fff9c4; color: #827717; border-color: #fbc02d; }
        .task-tag i { margin-left: 6px; cursor: pointer; color: var(--danger); }

        .control-group { display: flex; flex-direction: column; gap: 8px; background: #fdfdfd; padding: 15px; border-radius: 8px; border: 1px solid #eee; }
        select { padding: 8px; border-radius: 5px; border: 1px solid #ccc; font-size: 12px; outline: none; transition: 0.3s; }
        select:disabled { background: #f0f0f0; cursor: not-allowed; color: #aaa; }
        
        .btn-assign { background: var(--primary); color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .footer { text-align: center; padding: 15px; color: #777; font-size: 12px; background: #fff; margin-left: 260px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">
            <h2 style="color:var(--gold); margin:0;">OLMOTI</h2>
            <small>ADMIN PORTAL</small>
        </div>
        <ul class="nav-links">
            <li class="active"><a href="#"><i class="fas fa-tasks"></i> Assignments</a></li>
            <li><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
        </ul>
    </div>

    <div class="main-content">
        <div class="admin-box">
            <h3 style="color:var(--primary);"><i class="fas fa-user-shield"></i> Staff Multi-Tasking Manager</h3>
            <table>
                <thead>
                    <tr>
                        <th width="25%">Teacher</th>
                        <th width="45%">Current Assignments</th>
                        <th width="30%">New Assignment</th>
                    </tr>
                </thead>
                <tbody id="staffTable"></tbody>
            </table>
        </div>
    </div>

    <div class="footer">
        Developed by <b>elazaro14</b> | &copy; 2026 Olmoti Secondary School
    </div>

<script type="module">
    import { db, auth } from "./firebase.js";
    import { collection, getDocs, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const SUBJECTS_LOW = ["Biology", "Book-keeping", "Chemistry", "Civics", "English", "Geography", "History", "Kiswahili", "Mathematics", "Physics", "Historia ya Tz"];
    const SUBJECTS_HIGH = ["Biology", "Book-keeping", "Chemistry", "Civics", "Commerce", "English", "Geography", "History", "Kiswahili", "Literature", "Mathematics", "Physics"];

    // AUTO LOGOUT
    let timer;
    const reset = () => { clearTimeout(timer); timer = setTimeout(() => logout(), 30 * 60 * 1000); };
    window.addEventListener('mousemove', reset);

    onAuthStateChanged(auth, (user) => { if (user) { loadStaffList(); reset(); } else { window.location.href="index.html"; } });

    async function loadStaffList() {
        const snap = await getDocs(collection(db, "users"));
        const tbody = document.getElementById('staffTable');
        tbody.innerHTML = "";

        snap.forEach(userDoc => {
            const u = userDoc.data();
            const id = userDoc.id;
            const tasks = u.assignments || [];

            tbody.innerHTML += `
                <tr>
                    <td><b>${u.name || 'Staff'}</b><br><small>${u.email}</small></td>
                    <td><div id="list-${id}">${tasks.map((t, i) => `
                        <div class="task-tag ${t.type === 'Class Teacher' ? 'ct' : ''}">
                            ${t.type === 'Class Teacher' ? 'ðŸ“Œ' : 'ðŸ“š'} ${t.cls} ${t.strm} ${t.subj !== 'N/A' ? ': '+t.subj : ''}
                            <i class="fas fa-times" onclick="removeTask('${id}', ${i})"></i>
                        </div>`).join('')}</div>
                    </td>
                    <td>
                        <div class="control-group">
                            <select id="type-${id}" onchange="toggleSubject('${id}')">
                                <option value="Subject Teacher">Subject Teacher</option>
                                <option value="Class Teacher">Class Teacher</option>
                            </select>
                            <select id="cls-${id}" onchange="updateSubjList('${id}')">
                                <option value="Form 1">Form 1</option><option value="Form 2">Form 2</option>
                                <option value="Form 3">Form 3</option><option value="Form 4">Form 4</option>
                            </select>
                            <select id="strm-${id}">
                                <option value="ALL">ALL STREAMS</option>
                                <option>A</option><option>B</option><option>C</option><option>D</option><option>E</option><option>F</option><option>G</option>
                            </select>
                            <select id="subj-${id}">${SUBJECTS_LOW.map(s => `<option>${s}</option>`).join('')}</select>
                            <button class="btn-assign" onclick="addTask('${id}')">Assign Task</button>
                        </div>
                    </td>
                </tr>`;
        });
    }

    // Logic to disable subject if Class Teacher is selected
    window.toggleSubject = (id) => {
        const type = document.getElementById(`type-${id}`).value;
        const subjBox = document.getElementById(`subj-${id}`);
        if (type === "Class Teacher") {
            subjBox.disabled = true;
            subjBox.value = ""; 
        } else {
            subjBox.disabled = false;
            updateSubjList(id);
        }
    };

    window.updateSubjList = (id) => {
        const cls = document.getElementById(`cls-${id}`).value;
        const subjBox = document.getElementById(`subj-${id}`);
        if (subjBox.disabled) return;
        const list = (cls === "Form 1" || cls === "Form 2") ? SUBJECTS_LOW : SUBJECTS_HIGH;
        subjBox.innerHTML = list.map(s => `<option>${s}</option>`).join('');
    };

    window.addTask = async (userId) => {
        const type = document.getElementById(`type-${userId}`).value;
        const task = {
            type: type,
            cls: document.getElementById(`cls-${userId}`).value,
            strm: document.getElementById(`strm-${userId}`).value,
            subj: type === "Class Teacher" ? "N/A" : document.getElementById(`subj-${userId}`).value
        };
        const ref = doc(db, "users", userId);
        const snap = await getDoc(ref);
        let current = snap.data().assignments || [];
        current.push(task);
        await updateDoc(ref, { assignments: current });
        loadStaffList();
    };

    window.removeTask = async (userId, idx) => {
        const ref = doc(db, "users", userId);
        const snap = await getDoc(ref);
        let current = snap.data().assignments || [];
        current.splice(idx, 1);
        await updateDoc(ref, { assignments: current });
        loadStaffList();
    };

    window.logout = () => signOut(auth).then(() => window.location.href="index.html");
</script>
</body>
</html>

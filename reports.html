<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <title>Results Entry | Shule ERP</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav><a href="dashboard.html">â¬… Dashboard</a></nav>
    <div class="dashboard-container" style="max-width: 1100px; margin: auto; padding: 20px;">
        <h2>ðŸ“Š Teacher Mark Entry</h2>
        <div class="form-section">
            <select id="classSelect"><option value="">-- Class --</option><option value="Form 1">Form 1</option><option value="Form 2">Form 2</option><option value="Form 3">Form 3</option><option value="Form 4">Form 4</option></select>
            <select id="subjectSelect"><option value="">-- Subject --</option></select>
            <button id="loadBtn">Load Students</button>
        </div>
        <div id="entrySection" style="display:none;">
            <table border="1" width="100%">
                <thead><tr><th>Name</th><th>T1</th><th>Mid</th><th>T2</th><th>Exam</th><th>Avg</th><th>Grade</th></tr></thead>
                <tbody id="marksTbody"></tbody>
            </table>
            <button id="saveAllBtn" style="width:100%; padding:15px; background:green; color:white; margin-top:10px;">SAVE ALL RESULTS</button>
        </div>
    </div>

<script type="module">
    import { db } from "./firebase.js";
    import { subjectLists } from "./data.js";
    import { collection, getDocs, query, where, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    classSelect.onchange = () => {
        subjectSelect.innerHTML = '<option value="">-- Subject --</option>';
        if(subjectLists[classSelect.value]) subjectLists[classSelect.value].forEach(s => subjectSelect.innerHTML += `<option value="${s.code}">${s.name}</option>`);
    };

    loadBtn.onclick = async () => {
        const q = query(collection(db, "students"), where("cls", "==", classSelect.value));
        const snap = await getDocs(q);
        marksTbody.innerHTML = "";
        snap.forEach(sDoc => {
            marksTbody.innerHTML += `<tr class="student-row" data-id="${sDoc.id}" data-name="${sDoc.data().name}">
                <td>${sDoc.data().name}</td>
                <td><input type="number" class="score-in t1" style="width:50px"></td>
                <td><input type="number" class="score-in mid" style="width:50px"></td>
                <td><input type="number" class="score-in t2" style="width:50px"></td>
                <td><input type="number" class="score-in ex" style="width:50px"></td>
                <td class="avg">0</td><td class="grade">-</td>
            </tr>`;
        });
        entrySection.style.display = "block";
    };

    document.addEventListener('input', e => {
        if(e.target.classList.contains('score-in')) {
            const row = e.target.closest('tr');
            const scores = Array.from(row.querySelectorAll('.score-in')).map(i => parseFloat(i.value)).filter(v => !isNaN(v));
            const avg = scores.length > 0 ? (scores.reduce((a,b)=>a+b,0) / scores.length).toFixed(1) : 0;
            row.querySelector('.avg').innerText = avg;
            let g = "F"; if(avg>=75) g="A"; else if(avg>=65) g="B"; else if(avg>=45) g="C"; else if(avg>=30) g="D";
            row.querySelector('.grade').innerText = g;
        }
    });

    saveAllBtn.onclick = async () => {
        if(!subjectSelect.value) return alert("Select Subject!");
        const rows = document.querySelectorAll(".student-row");
        for(let row of rows) {
            const avg = parseFloat(row.querySelector('.avg').innerText);
            if(avg === 0) continue;
            await setDoc(doc(db, "results", `${row.dataset.id}_${subjectSelect.value}`), {
                studentId: row.dataset.id, subjectCode: subjectSelect.value,
                test1: parseFloat(row.querySelector('.t1').value)||0,
                midTerm: parseFloat(row.querySelector('.mid').value)||0,
                test2: parseFloat(row.querySelector('.t2').value)||0,
                exam: parseFloat(row.querySelector('.ex').value)||0,
                average: avg, grade: row.querySelector('.grade').innerText,
                remark: avg >= 30 ? "PASSED" : "FAILED"
            });
        }
        alert("Saved successfully!");
    };
</script>
</body>
</html>

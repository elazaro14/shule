<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Student Report | Olmoti ERP</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #1a237e; --bg: #f4f7f6; }
        body { font-family: 'Times New Roman', serif; background: var(--bg); margin: 0; padding: 20px; }
        
        .report-paper {
            background: white;
            width: 210mm;
            min-height: 297mm;
            margin: auto;
            padding: 50px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .header { text-align: center; border-bottom: 4px double var(--primary); padding-bottom: 10px; }
        .header h1 { margin: 0; color: var(--primary); font-size: 26px; }
        .header p { margin: 3px 0; font-size: 14px; text-transform: uppercase; }

        .student-details { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 30px 0; font-size: 16px; }
        .detail { border-bottom: 1px dashed #999; padding: 5px 0; }
        .detail b { color: #333; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid black; padding: 12px; text-align: center; }
        th { background: #f0f0f0; font-size: 12px; text-transform: uppercase; }
        .subject-name { text-align: left; font-weight: bold; }

        .performance-summary { margin-top: 40px; display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .remark-box { border: 1px solid black; padding: 15px; min-height: 80px; }
        .remark-box h4 { margin: 0 0 10px 0; font-size: 14px; text-decoration: underline; }

        .signature-section { margin-top: 60px; display: flex; justify-content: space-between; }
        .sig-line { border-top: 1px solid black; width: 220px; text-align: center; padding-top: 5px; font-weight: bold; }

        .no-print-bar { 
            background: white; padding: 15px; margin-bottom: 20px; 
            display: flex; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .btn-print { 
            background: #2e7d32; color: white; border: none; padding: 10px 30px; 
            border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 16px;
        }

        @media print {
            body { background: white; padding: 0; }
            .report-paper { box-shadow: none; margin: 0; width: 100%; border: none; }
            .no-print-bar { display: none; }
        }
    </style>
</head>
<body>

    <div class="no-print-bar">
        <button class="btn-print" onclick="window.print()"><i class="fas fa-print"></i> PRINT REPORT CARD</button>
    </div>

    <div class="report-paper">
        <div class="header">
            <h1>OLMOTI SECONDARY SCHOOL</h1>
            <p>P.O. BOX 123, ARUSHA, TANZANIA</p>
            <p><b>STUDENT ACADEMIC PROGRESS REPORT</b></p>
        </div>

        <div class="student-details">
            <div class="detail">Name: <b id="sName">...</b></div>
            <div class="detail">Gender: <b id="sSex">...</b></div>
            <div class="detail">Class: <b id="sClass">...</b></div>
            <div class="detail">Stream: <b id="sStream">...</b></div>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Subject</th>
                    <th>T1 (10)</th>
                    <th>Mid (20)</th>
                    <th>T2 (10)</th>
                    <th>Exam (60)</th>
                    <th>Total (100)</th>
                    <th>Grade</th>
                </tr>
            </thead>
            <tbody id="reportTbody">
                </tbody>
        </table>

        <div class="performance-summary">
            <div class="remark-box">
                <h4>CLASS TEACHER'S REMARKS:</h4>
                <p id="teacherRemark">........................................................................</p>
            </div>
            <div class="remark-box">
                <h4>HEADMASTER'S REMARKS:</h4>
                <p id="headRemark">........................................................................</p>
            </div>
        </div>

        <div class="signature-section">
            <div>
                <p style="height: 40px;"></p>
                <div class="sig-line">Parent/Guardian Signature</div>
            </div>
            <div>
                <p style="height: 40px;"></p>
                <div class="sig-line">Head of School Signature</div>
            </div>
        </div>
    </div>

<script type="module">
    import { db } from "./firebase.js";
    import { collection, getDocs, query, where, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const urlParams = new URLSearchParams(window.location.search);
    const studentId = urlParams.get('id');

    async function fetchReportData() {
        if(!studentId) return;

        // 1. Get Student Personal Info
        const sSnap = await getDoc(doc(db, "students", studentId));
        if(sSnap.exists()){
            const s = sSnap.data();
            document.getElementById('sName').innerText = s.name;
            document.getElementById('sSex').innerText = s.sex;
            document.getElementById('sClass').innerText = s.cls;
            document.getElementById('sStream').innerText = s.stream;
        }

        // 2. Get Student Marks
        const q = query(collection(db, "results"), where("studentId", "==", studentId));
        const rSnap = await getDocs(q);
        
        const tbody = document.getElementById('reportTbody');
        tbody.innerHTML = "";

        let grandTotal = 0;
        let count = 0;

        rSnap.forEach(d => {
            const r = d.data();
            grandTotal += parseFloat(r.total) || 0;
            count++;

            tbody.innerHTML += `
                <tr>
                    <td class="subject-name">${r.subjectCode}</td>
                    <td>${r.test1 || '-'}</td>
                    <td>${r.midTerm || '-'}</td>
                    <td>${r.test2 || '-'}</td>
                    <td>${r.exam || '-'}</td>
                    <td><b>${r.total}</b></td>
                    <td style="font-weight:bold;">${r.grade}</td>
                </tr>`;
        });

        // 3. Simple Auto-Remarking
        if(count > 0) {
            const avg = grandTotal / count;
            const remark = avg >= 75 ? "Excellent performance, keep it up!" :
                           avg >= 50 ? "Good work, aim higher next time." :
                           "Poor performance. Needs to put in more effort.";
            document.getElementById('teacherRemark').innerText = remark;
        }
    }

    fetchReportData();
</script>
</body>
</html>

<script type="module">
    import { db } from "./firebase.js";
    import { subjectLists } from "./data.js";
    import { doc, getDoc, getDocs, collection, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    async function loadReport() {
        const urlParams = new URLSearchParams(window.location.search);
        const studentId = urlParams.get('id');
        
        if(!studentId) return;

        try {
            // 1. Fetch Student & All Students in Class (for Ranking)
            const studentSnap = await getDoc(doc(db, "students", studentId));
            const student = studentSnap.data();
            const classQuery = query(collection(db, "students"), where("cls", "==", student.cls));
            const allClassSnap = await getDocs(classQuery);
            document.getElementById("totalStudents").innerText = allClassSnap.size;

            document.getElementById("studentName").innerText = student.name;
            document.getElementById("studentClass").innerText = student.cls;

            // 2. Fetch Results
            const resultsQuery = query(collection(db, "results"), where("studentId", "==", studentId));
            const resultsSnap = await getDocs(resultsQuery);
            const resultsData = {};
            resultsSnap.forEach(d => { resultsData[d.data().subjectCode] = d.data(); });

            // 3. Populate Table & Track Points for Division
            const subjects = subjectLists[student.cls] || [];
            const tbody = document.getElementById("reportTbody");
            let sumAvg = 0, countAvg = 0;
            let pointsList = [];

            subjects.forEach(sub => {
                const res = resultsData[sub.code] || {};
                const jaribio = (res.test1 || 0) + (res.midTerm || 0) + (res.test2 || 0);
                const avg = res.average || 0;
                const grade = res.grade || "-";
                
                if(avg > 0) { 
                    sumAvg += avg; 
                    countAvg++; 
                    // Point mapping: A=1, B=2, C=3, D=4, F=5
                    const pts = { "A":1, "B":2, "C":3, "D":4, "F":5 }[grade] || 5;
                    pointsList.push(pts);
                }

                tbody.innerHTML += `
                    <tr>
                        <td class="subject-col">${sub.name}</td>
                        <td>${jaribio || ''}</td>
                        <td>${res.exam || ''}</td>
                        <td>${res.test1 ? (jaribio + (res.exam || 0)) : ''}</td>
                        <td>${avg || ''}</td>
                        <td>${grade}</td>
                        <td>${res.remark || ''}</td>
                    </tr>
                `;
            });

            // 4. Calculate Division (Based on Best 7 Subjects)
            pointsList.sort((a, b) => a - b);
            const best7 = pointsList.slice(0, 7);
            const totalPoints = best7.reduce((a, b) => a + b, 0);
            
            let division = "FAIL";
            if (totalPoints >= 7 && totalPoints <= 17) division = "I";
            else if (totalPoints <= 21) division = "II";
            else if (totalPoints <= 25) division = "III";
            else if (totalPoints <= 33) division = "IV";
            else division = "0";

            document.getElementById("division").innerText = division;
            
            const finalAvg = countAvg > 0 ? (sumAvg / countAvg).toFixed(1) : 0;
            document.getElementById("overallAvg").innerText = finalAvg;

        } catch (e) {
            console.error(e);
        }
    }
    loadReport();
</script>

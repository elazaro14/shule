<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <title>Ripoti ya Maendeleo - Shule ya Sekondari Olmoti</title>
    <style>
        :root {
            --primary-blue: #1a237e;
            --accent-gold: #c5a059;
            --bg-light: #f4f7f6;
            --white: #ffffff;
            --success-green: #198754;
        }

        body { font-family: 'Times New Roman', serif; background: var(--bg-light); padding: 10px; margin: 0; }
        
        .no-print { 
            text-align: center; 
            margin-bottom: 20px; 
            display: flex; 
            justify-content: center; 
            gap: 15px; 
            padding: 10px;
        }
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-family: 'Segoe UI', sans-serif;
            transition: 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        .btn-dash { background: var(--primary-blue); color: white; }
        .btn-print { background: var(--success-green); color: white; }
        .btn-back { background: #6c757d; color: white; }

        .report-page { 
            background: var(--white); 
            width: 210mm; 
            min-height: 297mm; 
            margin: auto; 
            padding: 30px; 
            box-sizing: border-box; 
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        .header { text-align: center; line-height: 1.2; text-transform: uppercase; margin-bottom: 15px; border-bottom: 2px solid var(--primary-blue); padding-bottom: 10px; }
        .header h2 { margin: 2px 0; font-size: 18px; color: var(--primary-blue); }
        
        .student-info { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        
        table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        th, td { border: 1px solid black; padding: 6px; text-align: center; text-transform: uppercase; font-size: 12px; }
        th { background: var(--primary-blue); color: white; }
        
        .stats-box { 
            padding: 15px; 
            border: 2px solid var(--accent-gold); 
            background: #fffdf5;
            line-height: 2.2;
            font-size: 14px;
        }

        @media print {
            .no-print { display: none; }
            body { background: none; padding: 0; }
            .report-page { box-shadow: none; width: 100%; margin: 0; border: none; }
        }
    </style>
</head>
<body>

<div class="no-print">
    <a href="dashboard.html" class="btn btn-dash">üè† DASHBOARD</a>
    <button onclick="window.print()" class="btn btn-print">üñ®Ô∏è PRINT REPORT</button>
    <button onclick="window.history.back()" class="btn btn-back">‚¨ÖÔ∏è BACK</button>
</div>

<div class="report-page">
    <div class="header">
        <h3>OFISI YA WAZIRI MKUU</h3>
        <h3>TAWALA ZA MIKOA NA SERIKALI ZA MTAA</h3>
        <h2>HALMASHAURI YA JIJI LA ARUSHA</h2>
        <h2>SHULE YA SEKONDARI OLMOTI</h2>
        <p>S.L.P 8249, ARUSHA</p>
        <h3 style="text-decoration: underline; margin-top: 10px;">TAARIFA YA MAENDELEO YA MWANAFUNZI</h3>
    </div>

    <div class="student-info">
        <div><strong>JINA:</strong> <span id="studentName">Yukupakia...</span></div>
        <div><strong>KIDATO:</strong> <span id="studentClass">...</span></div>
    </div>

    <table>
        <thead>
            <tr>
                <th style="width: 30%;">SOMO</th>
                <th>JARIBIO</th>
                <th>MTIHANI</th>
                <th>JUMLA</th>
                <th>WASTANI</th>
                <th>DARAJA</th>
                <th>MAONI</th>
            </tr>
        </thead>
        <tbody id="reportTbody">
            <tr><td colspan="7">Inatafuta matokeo...</td></tr>
        </tbody>
    </table>

    <div style="display: flex; gap: 20px;">
        <div style="flex: 1.2;">
            <table border="1" style="width: 100%; border-collapse: collapse;">
                <thead><tr><th colspan="2" style="background: #eee; color: #000;">TATHMINI YA TABIA</th></tr></thead>
                <tbody>
                    <tr><td>UTII</td><td style="width: 60px;">B</td></tr>
                    <tr><td>USAFI</td><td>B</td></tr>
                    <tr><td>BIDII</td><td>B</td></tr>
                </tbody>
            </table>
        </div>
        <div class="stats-box" style="flex: 1;">
            <strong>WASTANI WA JUMLA:</strong> <span id="overallAvg">-</span><br>
            <strong>POINTS:</strong> <span id="totalPoints">-</span><br>
            <strong>DIVISION:</strong> <span id="division">-</span><br>
            <strong>NAFASI:</strong> <span id="rank">...</span> <strong>KATI YA</strong> <span id="totalStuds">...</span>
        </div>
    </div>
</div>

<script type="module">
    import { db } from "./firebase.js";
    import { subjectLists } from "./data.js";
    import { doc, getDoc, getDocs, collection, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    async function generateReport() {
        const urlParams = new URLSearchParams(window.location.search);
        const studentId = urlParams.get('id');
        if(!studentId) return;

        try {
            // 1. Fetch Student Info
            const sSnap = await getDoc(doc(db, "students", studentId));
            if (!sSnap.exists()) {
                document.getElementById("reportTbody").innerHTML = "<tr><td colspan='7'>Mwanafunzi hajapatikana!</td></tr>";
                return;
            }
            const student = sSnap.data();
            document.getElementById("studentName").innerText = student.name;
            const currentClass = student.cls;
            document.getElementById("studentClass").innerText = currentClass;

            // 2. Fetch Results for THIS student
            const rSnap = await getDocs(query(collection(db, "results"), where("studentId", "==", studentId)));
            const myResultsMap = {};
            rSnap.forEach(d => {
                const data = d.data();
                myResultsMap[data.subjectCode] = data;
            });

            // 3. Fetch All Class Results for Ranking
            const allResultsSnap = await getDocs(collection(db, "results"));
            const allStudentsSnap = await getDocs(query(collection(db, "students"), where("cls", "==", currentClass)));
            document.getElementById("totalStuds").innerText = allStudentsSnap.size;

            // 4. Populate Table
            const subjects = subjectLists[currentClass] || [];
            const tbody = document.getElementById("reportTbody");
            tbody.innerHTML = ""; // Clear loading text
            
            let sumW = 0, countS = 0, ptsArr = [];

            subjects.forEach(sub => {
                const res = myResultsMap[sub.code];
                if(res) {
                    const avg = parseFloat(res.average) || 0;
                    const grade = res.grade || "F";
                    
                    sumW += avg;
                    countS++;
                    ptsArr.push({"A":1,"B":2,"C":3,"D":4,"F":5}[grade] || 5);

                    tbody.innerHTML += `<tr>
                        <td style="text-align:left; padding-left:10px; font-weight:bold;">${sub.name}</td>
                        <td>${res.test1 || 0}</td>
                        <td>${res.exam || 0}</td>
                        <td>${(parseFloat(res.test1||0) + parseFloat(res.exam||0))}</td>
                        <td>${avg}</td>
                        <td>${grade}</td>
                        <td>${avg >= 30 ? 'PASS' : 'FAIL'}</td>
                    </tr>`;
                }
            });

            // 5. Points & Division Logic (BEST 7)
            if(countS >= 7) {
                ptsArr.sort((a,b) => a-b);
                const totalB7 = ptsArr.slice(0, 7).reduce((a,b) => a+b, 0);
                document.getElementById("totalPoints").innerText = totalB7;
                
                let div = "IV";
                if(totalB7 <= 17) div = "I";
                else if(totalB7 <= 21) div = "II";
                else if(totalB7 <= 25) div = "III";
                document.getElementById("division").innerText = div;
            } else {
                document.getElementById("totalPoints").innerText = "INC";
                document.getElementById("division").innerText = "";
            }

            document.getElementById("overallAvg").innerText = countS > 0 ? (sumW / countS).toFixed(1) : "0.0";

            // 6. Ranking Logic
            let rankingList = [];
            allStudentsSnap.forEach(sDoc => {
                let sSum = 0, sCount = 0, sPts = [];
                allResultsSnap.forEach(rDoc => {
                    const r = rDoc.data();
                    if(r.studentId === sDoc.id) {
                        sSum += parseFloat(r.average) || 0;
                        sCount++;
                        sPts.push({"A":1,"B":2,"C":3,"D":4,"F":5}[r.grade] || 5);
                    }
                });
                if(sCount >= 7) {
                    sPts.sort((a,b)=>a-b);
                    rankingList.push({ id: sDoc.id, avg: sSum/sCount, pts: sPts.slice(0,7).reduce((a,b)=>a+b,0) });
                } else {
                    rankingList.push({ id: sDoc.id, avg: 0, pts: 99 });
                }
            });
            rankingList.sort((a,b) => a.pts - b.pts || b.avg - a.avg);
            const myRank = rankingList.findIndex(x => x.id === studentId) + 1;
            document.getElementById("rank").innerText = myRank > 0 ? myRank : "-";

        } catch (e) {
            console.error("FIREBASE ERROR:", e);
            alert("Error loading results. Check internet or Firebase Console.");
        }
    }
    generateReport();
</script>
</body>
</html>

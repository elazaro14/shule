// --- Sehemu ya Logic ndani ya script yako ---

subjects.forEach(sub => {
    const res = myResMap[sub.code];
    
    // 1. Kazi ya kuangalia kama alama ipo au la
    const check = (val) => (val === "" || val === null || val === undefined) ? "-" : val;

    if(res) {
        // Jaribio: Tunachukua wastani wa yaliyopo tu
        let jScores = [];
        if(res.test1 && res.test1 !== "") jScores.push(parseFloat(res.test1));
        if(res.midTerm && res.midTerm !== "") jScores.push(parseFloat(res.midTerm));
        if(res.test2 && res.test2 !== "") jScores.push(parseFloat(res.test2));
        
        const hasJaribio = jScores.length > 0;
        const jaribio = hasJaribio ? (jScores.reduce((a,b)=>a+b,0)/jScores.length) : 0;
        
        // Mtihani: Kama haipo, weka kistari
        const mtihaniVal = (res.exam && res.exam !== "") ? parseFloat(res.exam) : null;
        const mtihaniDisplay = mtihaniVal !== null ? mtihaniVal : "-";
        
        // Jumla na Wastani: Hesabu tu ikiwa mtihani au jaribio lipo
        let jumlaDisplay = "-", wastaniDisplay = "-", grade = "-", maoni = "-";

        if(hasJaribio || mtihaniVal !== null) {
            const jumla = jaribio + (mtihaniVal || 0);
            const wastani = (jumla / 2).toFixed(1);
            const w = parseFloat(wastani);

            jumlaDisplay = jumla.toFixed(0);
            wastaniDisplay = wastani;

            // Grading Logic
            if(w >= 75) { grade="A"; maoni="VIZURI SANA"; }
            else if(w >= 65) { grade="B"; maoni="VIZURI"; }
            else if(w >= 45) { grade="C"; maoni="WASTANI"; }
            else if(w >= 30) { grade="D"; maoni="INARIDHISHA"; }
            else { grade="F"; maoni="FELI"; }

            sumW += w;
            countS++;
            ptsArr.push({"A":1,"B":2,"C":3,"D":4,"F":5}[grade]);
        }

        tbody.innerHTML += `<tr>
            <td class="subject-col">${sub.name}</td>
            <td>${hasJaribio ? jaribio.toFixed(0) : "-"}</td>
            <td>${mtihaniDisplay}</td>
            <td>${jumlaDisplay}</td>
            <td>${wastaniDisplay}</td>
            <td>${grade}</td>
            <td>${maoni}</td>
        </tr>`;
    } else {
        // Ikiwa somo halina matokeo kabisa kwenye database
        tbody.innerHTML += `<tr>
            <td class="subject-col">${sub.name}</td>
            <td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td>
        </tr>`;
    }
});

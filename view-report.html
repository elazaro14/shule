<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <title>Ripoti ya Maendeleo - Shule ya Sekondari Olmoti</title>
    <style>
        body { font-family: 'Times New Roman', serif; background: #f4f4f4; padding: 10px; margin: 0; }
        .report-page { background: white; width: 210mm; min-height: 297mm; margin: auto; padding: 30px; box-sizing: border-box; position: relative; }
        .header { text-align: center; line-height: 1.1; text-transform: uppercase; margin-bottom: 15px; }
        .header h2, .header h3 { margin: 2px 0; font-size: 16px; }
        .student-info { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; border-bottom: 2px solid #000; padding-bottom: 10px; }
        
        table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
        th, td { border: 1px solid black; padding: 4px; text-align: center; text-transform: uppercase; font-size: 11px; }
        th { background: #f0f0f0; }
        .subject-col { text-align: left; padding-left: 8px; font-weight: bold; }

        .summary-section { display: grid; grid-template-columns: 1.2fr 1fr; gap: 20px; margin-top: 10px; }
        .conduct-table td { text-align: left; padding-left: 10px; height: 18px; }

        .grading-key { display: flex; justify-content: space-between; font-size: 10px; border: 1px solid #000; padding: 8px; font-weight: bold; margin-top: 10px; }
        
        .dates-section { margin-top: 15px; font-weight: bold; font-size: 13px; }
        .footer-sections { margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .signature-line { border-bottom: 1px dotted black; margin-top: 15px; height: 15px; }
        
        /* Sehemu ya Mzazi Iliyopanuliwa */
        .parent-section { margin-top: 25px; border: 1px solid #000; padding: 15px; }
        .comment-box { height: 100px; border-bottom: 1px dotted #000; margin-bottom: 10px; }

        @media print {
            .no-print { display: none; }
            body { background: none; padding: 0; }
            .report-page { box-shadow: none; width: 100%; padding: 10px; border: none; }
        }
    </style>
</head>
<body>

<div class="no-print" style="text-align:center; margin-bottom:10px;">
    <button onclick="window.print()" style="padding: 10px 25px; background: #198754; color: white; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; font-size: 14px;">PRINT REPORT (CHAPA)</button>
</div>

<div class="report-page">
    <div class="header">
        <h3>OFISI YA WAZIRI MKUU</h3>
        <h3>TAWALA ZA MIKOA NA SERIKALI ZA MTAA</h3>
        <h2>HALMASHAURI YA JIJI LA ARUSHA</h2>
        <h2>SHULE YA SEKONDARI OLMOTI</h2>
        <p>S.L.P 8249, ARUSHA</p>
        <h3 style="text-decoration: underline; margin-top: 10px;">TAARIFA YA MAENDELEO YA MWANAFUNZI KWA MZAZI/MLEZI</h3>
    </div>

    <div class="student-info">
        <div><strong>JINA:</strong> <span id="studentName">...</span></div>
        <div><strong>KIDATO:</strong> <span id="studentClass">...</span></div>
        <div><strong>MUHULA:</strong> <span>I</span></div>
        <div><strong>MWAKA:</strong> <span>2025</span></div>
    </div>

    <table>
        <thead>
            <tr>
                <th style="width: 30%;">SOMO</th>
                <th>JARIBIO</th>
                <th>MTIHANI</th>
                <th>JUMLA</th>
                <th>WASTANI</th>
                <th>DARAJA</th>
                <th>MAONI</th>
            </tr>
        </thead>
        <tbody id="reportTbody"></tbody>
    </table>

    <div class="summary-section">
        <div>
            <table class="conduct-table">
                <thead><tr><th colspan="2">TATHMINI YA TABIA (CONDUCT)</th></tr></thead>
                <tbody>
                    <tr><td>Utii (Obedience)</td><td style="width:60px;"></td></tr>
                    <tr><td>Usafi (Neatness)</td><td></td></tr>
                    <tr><td>Bidii (Diligent)</td><td></td></tr>
                    <tr><td>Ushirikiano (Cooperation)</td><td></td></tr>
                    <tr><td>Uongozi (Leadership)</td><td></td></tr>
                </tbody>
            </table>
        </div>
        <div style="font-size: 13px; line-height: 2.2;">
            <strong>WASTANI WA JUMLA:</strong> <span id="overallAvg">-</span><br>
            <strong>POINTS:</strong> <span id="totalPoints">-</span><br>
            <strong>DIVISION:</strong> <span id="division">-</span><br>
            <strong>NAFASI:</strong> <span id="rank">...</span> <strong>KATI YA</strong> <span id="totalStuds">...</span>
        </div>
    </div>

    <div class="grading-key">
        <span>A = 75-100 (VIZURI SANA)</span>
        <span>B = 65-74 (VIZURI)</span>
        <span>C = 45-64 (WASTANI)</span>
        <span>D = 30-44 (INARIDHISHA)</span>
        <span>F = 0-29 (FELI)</span>
    </div>

    <div class="dates-section">
        Shule imefungwa tarehe ........................................... itafunguliwa tarehe ...........................................
    </div>

    <div class="footer-sections">
        <div>
            <p>Maoni ya mwalimu wa darasa:</p>
            <div class="signature-line"></div>
        </div>
        <div>
            <p>Maoni ya mkuu wa shule:</p>
            <div class="signature-line"></div>
        </div>
    </div>

    <div class="parent-section">
        <p><strong>MAONI YA MZAZI / MLEZI:</strong></p>
        <div class="comment-box"></div>
        <div style="display: flex; justify-content: space-between; margin-top: 5px;">
            <span>Sahihi: ...........................................</span>
            <span>Tarehe: ...........................................</span>
        </div>
    </div>
</div>

<script type="module">
    import { db } from "./firebase.js";
    import { subjectLists } from "./data.js";
    import { doc, getDoc, getDocs, collection, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    async function generateReport() {
        const urlParams = new URLSearchParams(window.location.search);
        const studentId = urlParams.get('id');
        if(!studentId) return;

        try {
            // 1. Maelezo ya Mwanafunzi
            const sSnap = await getDoc(doc(db, "students", studentId));
            const student = sSnap.data();
            document.getElementById("studentName").innerText = student.name;
            const currentClass = student.cls;
            document.getElementById("studentClass").innerText = currentClass;

            // 2. Tafuta Matokeo ya Darasa zima kwa ajili ya Nafasi (Ranking)
            const allResultsSnap = await getDocs(collection(db, "results"));
            const classAverages = [];
            
            // Hapa tunatengeneza ramani ya wastani wa kila mwanafunzi darasani
            const studentMap = {}; 
            allResultsSnap.forEach(d => {
                const data = d.data();
                if(!studentMap[data.studentId]) studentMap[data.studentId] = { sum: 0, count: 0 };
                studentMap[data.studentId].sum += data.average;
                studentMap[data.studentId].count++;
            });

            // Tafuta wanafunzi wa darasa hili tu
            const allStudsSnap = await getDocs(query(collection(db, "students"), where("cls", "==", currentClass)));
            document.getElementById("totalStuds").innerText = allStudsSnap.size;

            allStudsSnap.forEach(s => {
                const stats = studentMap[s.id];
                if(stats) {
                    classAverages.push({ id: s.id, avg: stats.sum / stats.count });
                }
            });

            // Panga kwa wastani wa juu kwenda chini
            classAverages.sort((a, b) => b.avg - a.avg);
            const myRank = classAverages.findIndex(x => x.id === studentId) + 1;
            document.getElementById("rank").innerText = myRank > 0 ? myRank : "-";

            // 3. Jaza Jedwali la Matokeo ya Mwanafunzi Huyu
            const rSnap = await getDocs(query(collection(db, "results"), where("studentId", "==", studentId)));
            const results = {};
            rSnap.forEach(d => results[d.data().subjectCode] = d.data());

            const subjects = subjectLists[currentClass] || [];
            const tbody = document.getElementById("reportTbody");
            let sumWastani = 0, countSomo = 0, pointsArr = [];

            subjects.forEach(sub => {
                const res = results[sub.code] || {};
                let jSum = 0, jCount = 0;
                if(res.test1) { jSum += res.test1; jCount++; }
                if(res.midTerm) { jSum += res.midTerm; jCount++; }
                if(res.test2) { jSum += res.test2; jCount++; }
                
                const jAvg = jCount > 0 ? (jSum / jCount) : 0;
                const mtihani = res.exam || 0;
                const jumla = jAvg + mtihani;
                const wastani = (jumla / 2).toFixed(1);

                let daraja = "F", maoni = "FELI";
                const w = parseFloat(wastani);
                if(w >= 75) { daraja = "A"; maoni = "VIZURI SANA"; }
                else if(w >= 65) { daraja = "B"; maoni = "VIZURI"; }
                else if(w >= 45) { daraja = "C"; maoni = "WASTANI"; }
                else if(w >= 30) { daraja = "D"; maoni = "INARIDHISHA"; }
                
                if(w > 0) {
                    sumWastani += w;
                    countSomo++;
                    pointsArr.push({"A":1,"B":2,"C":3,"D":4,"F":5}[daraja] || 5);
                    tbody.innerHTML += `<tr><td class="subject-col">${sub.name}</td><td>${jAvg.toFixed(0)}</td><td>${mtihani}</td><td>${jumla.toFixed(0)}</td><td>${wastani}</td><td>${daraja}</td><td>${maoni}</td></tr>`;
                }
            });

            const finalAvg = countSomo > 0 ? (sumWastani / countSomo).toFixed(1) : 0;
            document.getElementById("overallAvg").innerText = finalAvg;

            pointsArr.sort((a,b)=>a-b);
            const pts = pointsArr.slice(0, 7).reduce((a,b)=>a+b, 0);
            document.getElementById("totalPoints").innerText = pts;

            let divText = "0";
            if(pts >= 7 && pts <= 17) divText="I";
            else if(pts <= 21) divText="II";
            else if(pts <= 25) divText="III";
            else if(pts <= 33) divText="IV";
            document.getElementById("division").innerText = divText;

        } catch (e) { console.error("Error generating report:", e); }
    }
    generateReport();
</script>
</body>
</html>

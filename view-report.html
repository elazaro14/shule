<!DOCTYPE html>
<html lang="sw">
<head>
    <style>
        :root {
            --primary-blue: #1a237e;
            --accent-gold: #c5a059;
            --bg-light: #f4f7f6;
            --white: #ffffff;
            --success-green: #198754;
        }

        body { font-family: 'Times New Roman', serif; background: var(--bg-light); padding: 10px; margin: 0; }
        
        .no-print { 
            text-align: center; 
            margin-bottom: 20px; 
            display: flex; 
            justify-content: center; 
            gap: 15px; 
            padding: 10px;
        }
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-family: 'Segoe UI', sans-serif;
            transition: 0.3s;
            text-decoration: none;
            display: inline-block;
            color: white;
        }
        .btn-dash { background: var(--primary-blue); }
        .btn-print { background: var(--success-green); }
        .btn-back { background: #6c757d; }

        .report-page { 
            background: var(--white); 
            width: 210mm; 
            min-height: 297mm; 
            margin: auto; 
            padding: 25px; 
            box-sizing: border-box; 
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .header { text-align: center; line-height: 1.2; text-transform: uppercase; margin-bottom: 10px; border-bottom: 2px solid var(--primary-blue); padding-bottom: 5px; }
        .header h2 { margin: 2px 0; font-size: 18px; color: var(--primary-blue); }
        .header h3 { margin: 2px 0; font-size: 14px; }
        
        .student-info { display: grid; grid-template-columns: 1.5fr 1fr; gap: 10px; margin: 15px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        
        table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
        th, td { border: 1px solid black; padding: 5px; text-align: center; text-transform: uppercase; font-size: 11px; }
        th { background: #f2f2f2; color: black; }
        .subject-col { text-align: left; padding-left: 8px; font-weight: bold; }

        .summary-container { display: grid; grid-template-columns: 1.2fr 1fr; gap: 15px; margin-top: 10px; }
        
        .stats-box { 
            padding: 10px; 
            border: 2px solid var(--accent-gold); 
            background: #fffdf5;
            line-height: 1.8;
            font-size: 13px;
        }

        .grading-key { display: flex; justify-content: space-between; font-size: 9px; border: 1px solid #000; padding: 5px; font-weight: bold; margin-top: 10px; background: #f9f9f9; }
        
        .footer-sections { margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .sig-box { border-top: 1px dotted black; text-align: center; padding-top: 5px; font-size: 11px; margin-top: 15px; }
        .comment-display { font-size: 11px; font-weight: bold; min-height: 18px; margin-bottom: 5px; text-transform: uppercase; }

        .parent-section { margin-top: 20px; border: 1px solid #000; padding: 10px; }
        .comment-box { height: 50px; border-bottom: 1px dotted #000; }

        .screen-timestamp { 
            font-size: 10px; 
            color: #666; 
            text-align: right; 
            margin-top: 5px; 
            font-style: italic;
        }

        @media print {
            @page { margin: 10mm; }
            body { margin: 0; background: none; }
            .no-print { display: none !important; }
            .report-page { box-shadow: none; width: 100%; margin: 0; border: none; padding: 10px; }
        }
    </style>
</head>
<body>

<div class="no-print">
    <div style="display: flex; flex-direction: column; align-items: center; gap: 10px; width: 100%;">
        <div style="display: flex; gap: 15px;">
            <a href="dashboard.html" class="btn btn-dash">üè† DASHBOARD</a>
            <button onclick="window.print()" class="btn btn-print">üñ®Ô∏è CHAPA (PRINT)</button>
            <button onclick="goBack()" class="btn btn-back">‚¨ÖÔ∏è RUDI (BACK)</button>
        </div>
        <div id="printTime" class="screen-timestamp"></div>
    </div>
</div>

<div class="report-page">
    <div class="header">
        <h3>OFISI YA WAZIRI MKUU</h3>
        <h3>TAWALA ZA MIKOA NA SERIKALI ZA MTAA</h3>
        <h2>HALMASHAURI YA JIJI LA ARUSHA</h2>
        <h2>SHULE YA SEKONDARI OLMOTI</h2>
        <p>S.L.P 8249, ARUSHA</p>
        <h3 style="text-decoration: underline; margin-top: 5px;">TAARIFA YA MAENDELEO YA MWANAFUNZI KWA MZAZI/MLEZI</h3>
    </div>

    <div class="student-info">
        <div><strong>JINA:</strong> <span id="studentName">...</span></div>
        <div><strong>MWAKA:</strong> <span id="yearVal">2026</span></div>
        <div><strong>KIDATO:</strong> <span id="studentClass">...</span></div>
        <div><strong>MUHULA:</strong> <span id="termVal">...</span></div>
    </div>

    <table>
        <thead>
            <tr>
                <th style="width: 30%;">SOMO</th>
                <th>JARIBIO</th>
                <th>MTIHANI</th>
                <th>JUMLA</th>
                <th>WASTANI</th>
                <th>DARAJA</th>
                <th>MAONI</th>
            </tr>
        </thead>
        <tbody id="reportTbody"></tbody>
    </table>

    <div class="summary-container">
        <table style="width: 100%;">
            <thead><tr><th colspan="2">TATHMINI YA TABIA (CONDUCT)</th></tr></thead>
            <tbody>
                <tr><td style="text-align: left; padding-left: 10px;">UTII (OBEDIENCE)</td><td style="width:60px;">B</td></tr>
                <tr><td style="text-align: left; padding-left: 10px;">USAFI (NEATNESS)</td><td>B</td></tr>
                <tr><td style="text-align: left; padding-left: 10px;">BIDII (DILIGENT)</td><td>B</td></tr>
                <tr><td style="text-align: left; padding-left: 10px;">USHIRIKIANO (COOPERATION)</td><td>B</td></tr>
            </tbody>
        </table>

        <div class="stats-box">
            <strong>WASTANI WA JUMLA:</strong> <span id="overallAvg">-</span><br>
            <strong>POINTS (BEST 7):</strong> <span id="totalPoints">-</span><br>
            <strong>DIVISION:</strong> <span id="division">-</span><br>
            <strong>NAFASI:</strong> <span id="rank">...</span> <strong>KATI YA</strong> <span id="totalStuds">...</span>
        </div>
    </div>

    <div class="grading-key">
        <span>A = 75-100 (VIZURI SANA)</span>
        <span>B = 65-74 (VIZURI)</span>
        <span>C = 45-64 (WASTANI)</span>
        <span>D = 30-44 (INARIDHISHA)</span>
        <span>F = 0-29 (FELI)</span>
    </div>

    <div class="footer-sections">
        <div>
            <p>Maoni ya mwalimu wa darasa:</p>
            <div id="classTeacherComment" class="comment-display"></div>
            <div class="sig-box">Sahihi ya Mwalimu wa Darasa</div>
        </div>
        <div>
            <p>Maoni ya mkuu wa shule:</p>
            <div id="headmasterComment" class="comment-display"></div>
            <div class="sig-box">Sahihi ya Mkuu wa Shule</div>
        </div>
    </div>

    <div class="parent-section">
        <p><strong>MAONI YA MZAZI / MLEZI (PARENT COMMENT):</strong></p>
        <div class="comment-box"></div>
        <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 11px;">
            <span>Sahihi: ...........................</span>
            <span>Tarehe: ...........................</span>
        </div>
    </div>
</div>

<script type="module">
    import { db } from "./firebase.js";
    import { subjectLists } from "./data.js";
    import { doc, getDoc, getDocs, collection, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    window.goBack = () => {
        if (document.referrer === "" || document.referrer.indexOf(window.location.host) === -1) {
            window.location.href = "dashboard.html";
        } else {
            window.history.back();
        }
    };

    async function generateReport() {
        const urlParams = new URLSearchParams(window.location.search);
        const studentId = urlParams.get('id');
        if(!studentId) return;

        try {
            const sSnap = await getDoc(doc(db, "students", studentId));
            if(!sSnap.exists()) return;
            const student = sSnap.data();
            document.getElementById("studentName").innerText = student.name;
            document.getElementById("studentClass").innerText = student.cls;
            
            const now = new Date();
            document.getElementById("yearVal").innerText = now.getFullYear();
            document.getElementById("termVal").innerText = (now.getMonth() < 6) ? "I" : "II";

            // Timestamp displayed only on screen (inside no-print div)
            const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            document.getElementById("printTime").innerText = "Muda wa sasa: " + now.toLocaleDateString('sw-TZ', options);

            const rSnap = await getDocs(query(collection(db, "results"), where("studentId", "==", studentId)));
            const myResMap = {};
            rSnap.forEach(d => myResMap[d.data().subjectCode] = d.data());

            const allResSnap = await getDocs(collection(db, "results"));
            const allStudSnap = await getDocs(query(collection(db, "students"), where("cls", "==", student.cls)));
            document.getElementById("totalStuds").innerText = allStudSnap.size;

            const subjects = subjectLists[student.cls] || [];
            const tbody = document.getElementById("reportTbody");
            tbody.innerHTML = "";
            
            let sumW = 0, countS = 0, ptsArr = [];

            subjects.forEach(sub => {
                const res = myResMap[sub.code];
                let jarStr = "-", exStr = "-", totStr = "-", avgStr = "-", grade = "-", maoni = "-";

                if(res) {
                    let jScores = [res.test1, res.midTerm, res.test2].filter(v => v && v !== "").map(v => parseFloat(v));
                    const hasJar = jScores.length > 0;
                    const jar = hasJar ? (jScores.reduce((a,b)=>a+b,0)/jScores.length) : 0;
                    const hasEx = res.exam && res.exam !== "";
                    const ex = hasEx ? parseFloat(res.exam) : 0;

                    if (hasJar || hasEx) {
                        const total = jar + ex;
                        const wastani = (total / 2).toFixed(1);
                        const w = parseFloat(wastani);
                        
                        jarStr = hasJar ? jar.toFixed(0) : "-";
                        exStr = hasEx ? ex : "-";
                        totStr = total.toFixed(0);
                        avgStr = wastani;

                        grade = w >= 75 ? "A" : w >= 65 ? "B" : w >= 45 ? "C" : w >= 30 ? "D" : "F";
                        maoni = w >= 75 ? "VIZURI SANA" : w >= 65 ? "VIZURI" : w >= 45 ? "WASTANI" : w >= 30 ? "INARIDHISHA" : "FELI";

                        sumW += w;
                        countS++;
                        ptsArr.push({"A":1,"B":2,"C":3,"D":4,"F":5}[grade]);
                    }
                }

                tbody.innerHTML += `<tr>
                    <td class="subject-col">${sub.name}</td>
                    <td>${jarStr}</td><td>${exStr}</td><td>${totStr}</td>
                    <td>${avgStr}</td><td>${grade}</td><td>${maoni}</td>
                </tr>`;
            });

            let finalDiv = "-";
            document.getElementById("overallAvg").innerText = countS > 0 ? (sumW / countS).toFixed(1) : "-";
            
            if(countS >= 7) {
                ptsArr.sort((a,b)=>a-b);
                const b7 = ptsArr.slice(0, 7).reduce((a,b)=>a+b, 0);
                document.getElementById("totalPoints").innerText = b7;
                finalDiv = b7 <= 17 ? "I" : b7 <= 21 ? "II" : b7 <= 25 ? "III" : "IV";
                document.getElementById("division").innerText = finalDiv;
            } else {
                document.getElementById("totalPoints").innerText = "INC";
                document.getElementById("division").innerText = "-";
            }

            // DYNAMIC COMMENTS
            let teacherComment = "";
            if (finalDiv === "I" || finalDiv === "II") {
                teacherComment = "Hongera, soma kwa bidii zaidi.";
            } else if (finalDiv === "III") {
                teacherComment = "Ongeza bidii kwenye masomo.";
            } else {
                teacherComment = "Matokeo yako sio mazuri soma kwa bidii zaidi.";
            }
            document.getElementById("classTeacherComment").innerText = teacherComment;
            document.getElementById("headmasterComment").innerText = teacherComment;

            // RANKING
            let rankingData = [];
            allStudSnap.forEach(sDoc => {
                let sSum = 0, sCount = 0, sPts = [];
                allResSnap.forEach(rDoc => {
                    const r = rDoc.data();
                    if(r.studentId === sDoc.id) {
                        let sjScores = [r.test1, r.midTerm, r.test2].filter(v => v && v !== "").map(v => parseFloat(v));
                        let sj = sjScores.length > 0 ? (sjScores.reduce((a,b)=>a+b,0)/sjScores.length) : 0;
                        let sm = parseFloat(r.exam) || 0;
                        if(sj > 0 || sm > 0) {
                            let sw = (sj + sm) / 2;
                            sSum += sw; sCount++;
                            let sg = sw >= 75 ? "A" : sw >= 65 ? "B" : sw >= 45 ? "C" : sw >= 30 ? "D" : "F";
                            sPts.push({"A":1,"B":2,"C":3,"D":4,"F":5}[sg]);
                        }
                    }
                });
                if(sCount >= 7) {
                    sPts.sort((a,b)=>a-b);
                    rankingData.push({ id: sDoc.id, pts: sPts.slice(0,7).reduce((a,b)=>a+b,0), avg: sSum/sCount });
                } else {
                    rankingData.push({ id: sDoc.id, pts: 999, avg: 0 });
                }
            });
            rankingData.sort((a,b) => a.pts - b.pts || b.avg - a.avg);
            const myRank = rankingData.findIndex(x => x.id === studentId) + 1;
            document.getElementById("rank").innerText = myRank > 0 ? myRank : "-";

        } catch (e) { console.error(e); }
    }
    generateReport();
</script>
</body>
</html>

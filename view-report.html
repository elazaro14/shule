<script type="module">
    import { db } from "./firebase.js";
    import { subjectLists } from "./data.js";
    import { doc, getDoc, getDocs, collection, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    async function generateReport() {
        const urlParams = new URLSearchParams(window.location.search);
        const studentId = urlParams.get('id');
        if(!studentId) return;

        try {
            // 1. Get Current Student Info [cite: 6, 7]
            const sSnap = await getDoc(doc(db, "students", studentId));
            const student = sSnap.data();
            document.getElementById("studentName").innerText = student.name;
            const currentClass = student.cls;
            document.getElementById("studentClass").innerText = currentClass;

            // 2. NAFASI (Ranking) Logic 
            // Fetch all students in this class
            const allStudsSnap = await getDocs(query(collection(db, "students"), where("cls", "==", currentClass)));
            const classResultsSnap = await getDocs(collection(db, "results"));
            
            let classRankingArray = [];

            // Calculate average for every student in the class to determine rank
            allStudsSnap.forEach(sDoc => {
                let sSum = 0;
                let sCount = 0;
                let sPoints = [];

                classResultsSnap.forEach(rDoc => {
                    const rData = rDoc.data();
                    if(rData.studentId === sDoc.id) {
                        const avg = parseFloat(rData.average) || 0;
                        sSum += avg;
                        sCount++;
                        // Map grade to points for Best 7 [cite: 8, 9]
                        const p = {"A":1,"B":2,"C":3,"D":4,"F":5}[rData.grade] || 5;
                        sPoints.push(p);
                    }
                });

                if(sCount > 0) {
                    const finalAvg = sSum / sCount;
                    sPoints.sort((a, b) => a - b);
                    const best7 = sPoints.slice(0, 7).reduce((a, b) => a + b, 0);
                    
                    classRankingArray.push({
                        id: sDoc.id,
                        avg: finalAvg,
                        points: best7
                    });
                }
            });

            // Rank Basis: Primary by Points (Lower is better), Secondary by Average (Higher is better) 
            classRankingArray.sort((a, b) => a.points - b.points || b.avg - a.avg);
            
            const myRank = classRankingArray.findIndex(x => x.id === studentId) + 1;
            document.getElementById("rank").innerText = myRank;
            document.getElementById("totalStuds").innerText = allStudsSnap.size;

            // 3. Render Table & Points for Current Student [cite: 7]
            const rSnap = await getDocs(query(collection(db, "results"), where("studentId", "==", studentId)));
            const results = {};
            rSnap.forEach(d => results[d.data().subjectCode] = d.data());

            const subjects = subjectLists[currentClass] || [];
            const tbody = document.getElementById("reportTbody");
            let sumWastani = 0, countSomo = 0, pointsArr = [];

            subjects.forEach(sub => {
                const res = results[sub.code];
                if(res) {
                    const wastani = parseFloat(res.average) || 0;
                    const daraja = res.grade || "F";
                    
                    sumWastani += wastani;
                    countSomo++;
                    // Point Calculation: A=1, B=2, C=3, D=4, F=5 
                    pointsArr.push({"A":1,"B":2,"C":3,"D":4,"F":5}[daraja] || 5);

                    tbody.innerHTML += `<tr>
                        <td class="subject-col">${sub.name}</td>
                        <td>${res.test1 || '-'}</td>
                        <td>${res.exam || '-'}</td>
                        <td>${(parseFloat(res.test1||0) + parseFloat(res.exam||0))}</td>
                        <td>${wastani}</td>
                        <td>${daraja}</td>
                        <td>${wastani >= 30 ? 'INARIDHISHA' : 'FELI'}</td>
                    </tr>`;
                }
            });

            // 4. Final Best 7 Points Calculation 
            pointsArr.sort((a, b) => a - b); // Lowest 7 scores (1 is best, 5 is worst)
            const totalBest7Points = pointsArr.slice(0, 7).reduce((a, b) => a + b, 0);
            document.getElementById("totalPoints").innerText = totalBest7Points;

            // Division Logic based on Points 
            let divText = "IV";
            if(totalBest7Points >= 7 && totalBest7Points <= 17) divText = "I";
            else if(totalBest7Points <= 21) divText = "II";
            else if(totalBest7Points <= 25) divText = "III";
            else if(totalBest7Points <= 33) divText = "IV";
            else divText = "0";
            document.getElementById("division").innerText = divText;

            document.getElementById("overallAvg").innerText = (sumWastani / countSomo).toFixed(1);

        } catch (e) { console.error("Error:", e); }
    }
    generateReport();
</script>

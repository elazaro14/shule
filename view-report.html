<script type="module">
    import { db } from "./firebase.js";
    import { subjectLists } from "./data.js";
    import { doc, getDoc, getDocs, collection, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    async function generateReport() {
        const urlParams = new URLSearchParams(window.location.search);
        const studentId = urlParams.get('id');
        
        // 1. Basic check to prevent crash if ID is missing
        if(!studentId) {
            console.error("No Student ID found in URL");
            return;
        }

        try {
            // 2. Fetch Student Info
            const sSnap = await getDoc(doc(db, "students", studentId));
            if(!sSnap.exists()) {
                console.error("Student not found");
                return;
            }
            const student = sSnap.data();

            // Safely fill headers
            const nameEl = document.getElementById("studentName");
            const classEl = document.getElementById("studentClass");
            if(nameEl) nameEl.innerText = student.name;
            if(classEl) classEl.innerText = student.cls;

            // 3. Fetch Results
            const rSnap = await getDocs(query(collection(db, "results"), where("studentId", "==", studentId)));
            const myResMap = {};
            rSnap.forEach(d => {
                myResMap[d.data().subjectCode] = d.data();
            });

            // 4. Get Subjects (Handle case where class name doesn't match data.js)
            const subjects = subjectLists[student.cls] || [];
            const tbody = document.getElementById("reportTbody");
            if(!tbody) return; 
            tbody.innerHTML = "";
            
            let sumW = 0, countS = 0, ptsArr = [];

            // 5. Generate Table Rows (Looping through ALL class subjects)
            subjects.forEach(sub => {
                const res = myResMap[sub.code];
                const isValid = (val) => val !== "" && val !== null && val !== undefined;

                let jaribioStr = "-", mtihaniStr = "-", jumlaStr = "-", wastaniStr = "-", grade = "-", maoni = "-";

                if(res) {
                    let jScores = [];
                    if(isValid(res.test1)) jScores.push(parseFloat(res.test1));
                    if(isValid(res.midTerm)) jScores.push(parseFloat(res.midTerm));
                    if(isValid(res.test2)) jScores.push(parseFloat(res.test2));
                    
                    const hasJaribio = jScores.length > 0;
                    const jaribio = hasJaribio ? (jScores.reduce((a,b)=>a+b,0)/jScores.length) : 0;
                    const mtihani = isValid(res.exam) ? parseFloat(res.exam) : null;
                    
                    if(hasJaribio) jaribioStr = jaribio.toFixed(0);
                    if(mtihani !== null) mtihaniStr = mtihani;

                    // Only calculate Math/Grades for subjects that have at least one mark
                    if (hasJaribio || mtihani !== null) {
                        const jumla = (hasJaribio ? jaribio : 0) + (mtihani || 0);
                        const wastani = (jumla / 2).toFixed(1);
                        const w = parseFloat(wastani);

                        jumlaStr = jumla.toFixed(0);
                        wastaniStr = wastani;

                        if(w >= 75) { grade="A"; maoni="VIZURI SANA"; }
                        else if(w >= 65) { grade="B"; maoni="VIZURI"; }
                        else if(w >= 45) { grade="C"; maoni="WASTANI"; }
                        else if(w >= 30) { grade="D"; maoni="INARIDHISHA"; }
                        else { grade="F"; maoni="FELI"; }

                        // Stats used for Overall Average and Best 7
                        sumW += w;
                        countS++;
                        ptsArr.push({"A":1,"B":2,"C":3,"D":4,"F":5}[grade]);
                    }
                }

                // Row appears even if no marks exist
                tbody.innerHTML += `<tr>
                    <td class="subject-col">${sub.name}</td>
                    <td>${jaribioStr}</td>
                    <td>${mtihaniStr}</td>
                    <td>${jumlaStr}</td>
                    <td>${wastaniStr}</td>
                    <td>${grade}</td>
                    <td>${maoni}</td>
                </tr>`;
            });

            // 6. Statistics Calculations
            const avgEl = document.getElementById("overallAvg");
            if(avgEl) avgEl.innerText = countS > 0 ? (sumW / countS).toFixed(1) : "-";
            
            const ptsEl = document.getElementById("totalPoints");
            const divEl = document.getElementById("division");

            if(countS >= 7) {
                ptsArr.sort((a,b)=>a-b);
                const b7 = ptsArr.slice(0, 7).reduce((a,b)=>a+b, 0);
                if(ptsEl) ptsEl.innerText = b7;
                let d = "IV";
                if(b7 <= 17) d="I"; else if(b7 <= 21) d="II"; else if(b7 <= 25) d="III";
                if(divEl) divEl.innerText = d;
            } else {
                if(ptsEl) ptsEl.innerText = "INC";
                if(divEl) divEl.innerText = "-";
            }

            // Total Students Count
            const allStudSnap = await getDocs(query(collection(db, "students"), where("cls", "==", student.cls)));
            const totalStudsEl = document.getElementById("totalStuds");
            if(totalStudsEl) totalStudsEl.innerText = allStudSnap.size;

        } catch (e) { 
            console.error("Report System Error: ", e);
            // This prevents a total white screen by showing an error message
            const tbody = document.getElementById("reportTbody");
            if(tbody) tbody.innerHTML = `<tr><td colspan="7" style="color:red">Error: ${e.message}</td></tr>`;
        }
    }
    generateReport();
</script>

<!DOCTYPE html>
<html lang="sw">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <title>Ripoti ya Maendeleo - Shule ya Sekondari Olmoti</title>
Â  Â  <style>
Â  Â  Â  Â  :root {
Â  Â  Â  Â  Â  Â  --primary-blue: #1a237e;
Â  Â  Â  Â  Â  Â  --accent-gold: #c5a059;
Â  Â  Â  Â  Â  Â  --bg-light: #f4f7f6;
Â  Â  Â  Â  Â  Â  --white: #ffffff;
Â  Â  Â  Â  Â  Â  --success-green: #198754;
Â  Â  Â  Â  }

Â  Â  Â  Â  body { font-family: 'Times New Roman', serif; background: var(--bg-light); padding: 10px; margin: 0; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .no-print {Â 
Â  Â  Â  Â  Â  Â  text-align: center;Â 
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;Â 
Â  Â  Â  Â  Â  Â  display: flex;Â 
Â  Â  Â  Â  Â  Â  justify-content: center;Â 
Â  Â  Â  Â  Â  Â  gap: 15px;Â 
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn {
Â  Â  Â  Â  Â  Â  padding: 12px 25px;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  font-family: 'Segoe UI', sans-serif;
Â  Â  Â  Â  Â  Â  transition: 0.3s;
Â  Â  Â  Â  Â  Â  text-decoration: none;
Â  Â  Â  Â  Â  Â  display: inline-block;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-dash { background: var(--primary-blue); }
Â  Â  Â  Â  .btn-print { background: var(--success-green); }
Â  Â  Â  Â  .btn-back { background: #6c757d; }

Â  Â  Â  Â  .report-page {Â 
Â  Â  Â  Â  Â  Â  background: var(--white);Â 
Â  Â  Â  Â  Â  Â  width: 210mm;Â 
Â  Â  Â  Â  Â  Â  min-height: 297mm;Â 
Â  Â  Â  Â  Â  Â  margin: auto;Â 
Â  Â  Â  Â  Â  Â  padding: 25px;Â 
Â  Â  Â  Â  Â  Â  box-sizing: border-box;Â 
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 20px rgba(0,0,0,0.1);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .header { text-align: center; line-height: 1.2; text-transform: uppercase; margin-bottom: 10px; border-bottom: 2px solid var(--primary-blue); padding-bottom: 5px; }
Â  Â  Â  Â  .header h2 { margin: 2px 0; font-size: 18px; color: var(--primary-blue); }
Â  Â  Â  Â  .header h3 { margin: 2px 0; font-size: 14px; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .student-info { display: grid; grid-template-columns: 1.5fr 1fr; gap: 10px; margin: 15px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
Â  Â  Â  Â  th, td { border: 1px solid black; padding: 5px; text-align: center; text-transform: uppercase; font-size: 11px; }
Â  Â  Â  Â  th { background: #f2f2f2; color: black; }
Â  Â  Â  Â  .subject-col { text-align: left; padding-left: 8px; font-weight: bold; }

Â  Â  Â  Â  .summary-container { display: grid; grid-template-columns: 1.2fr 1fr; gap: 15px; margin-top: 10px; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .stats-box {Â 
Â  Â  Â  Â  Â  Â  padding: 10px;Â 
Â  Â  Â  Â  Â  Â  border: 2px solid var(--accent-gold);Â 
Â  Â  Â  Â  Â  Â  background: #fffdf5;
Â  Â  Â  Â  Â  Â  line-height: 1.8;
Â  Â  Â  Â  Â  Â  font-size: 13px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .grading-key { display: flex; justify-content: space-between; font-size: 9px; border: 1px solid #000; padding: 5px; font-weight: bold; margin-top: 10px; background: #f9f9f9; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .footer-sections { margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
Â  Â  Â  Â  .sig-box { border-top: 1px dotted black; text-align: center; padding-top: 5px; font-size: 11px; margin-top: 35px; }

Â  Â  Â  Â  .parent-section { margin-top: 20px; border: 1px solid #000; padding: 10px; }
Â  Â  Â  Â  .comment-box { height: 50px; border-bottom: 1px dotted #000; }

Â  Â  Â  Â  @media print {
Â  Â  Â  Â  Â  Â  .no-print { display: none; }
Â  Â  Â  Â  Â  Â  body { background: none; padding: 0; }
Â  Â  Â  Â  Â  Â  .report-page { box-shadow: none; width: 100%; margin: 0; border: none; }
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body>

<div class="no-print">
Â  Â  <a href="dashboard.html" class="btn btn-dash">ğŸ  DASHBOARD</a>
Â  Â  <button onclick="window.print()" class="btn btn-print">ğŸ–¨ï¸ CHAPA (PRINT)</button>
Â  Â  <button onclick="window.history.back()" class="btn btn-back">â¬…ï¸ RUDI (BACK)</button>
</div>

<div class="report-page">
Â  Â  <div class="header">
Â  Â  Â  Â  <h3>OFISI YA WAZIRI MKUU</h3>
Â  Â  Â  Â  <h3>TAWALA ZA MIKOA NA SERIKALI ZA MTAA</h3>
Â  Â  Â  Â  <h2>HALMASHAURI YA JIJI LA ARUSHA</h2>
Â  Â  Â  Â  <h2>SHULE YA SEKONDARI OLMOTI</h2>
Â  Â  Â  Â  <p>S.L.P 8249, ARUSHA</p>
Â  Â  Â  Â  <h3 style="text-decoration: underline; margin-top: 5px;">TAARIFA YA MAENDELEO YA MWANAFUNZI KWA MZAZI/MLEZI</h3>
Â  Â  </div>

Â  Â  <div class="student-info">
Â  Â  Â  Â  <div><strong>JINA:</strong> <span id="studentName">...</span></div>
Â  Â  Â  Â  <div><strong>MWAKA:</strong> <span id="yearVal">2025</span></div>
Â  Â  Â  Â  <div><strong>KIDATO:</strong> <span id="studentClass">...</span></div>
Â  Â  Â  Â  <div><strong>MUHULA:</strong> <span>I</span></div>
Â  Â  </div>

Â  Â  <table>
Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  <th style="width: 30%;">SOMO</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th>JARIBIO</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th>MTIHANI</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th>JUMLA</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th>WASTANI</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th>DARAJA</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th>MAONI</th>
Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  </thead>
Â  Â  Â  Â  <tbody id="reportTbody"></tbody>
Â  Â  </table>

Â  Â  <div class="summary-container">
Â  Â  Â  Â  <table style="width: 100%;">
Â  Â  Â  Â  Â  Â  <thead><tr><th colspan="2">TATHMINI YA TABIA (CONDUCT)</th></tr></thead>
Â  Â  Â  Â  Â  Â  <tbody>
Â  Â  Â  Â  Â  Â  Â  Â  <tr><td style="text-align: left; padding-left: 10px;">UTII (OBEDIENCE)</td><td style="width:60px;">B</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  <tr><td style="text-align: left; padding-left: 10px;">USAFI (NEATNESS)</td><td>B</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  <tr><td style="text-align: left; padding-left: 10px;">BIDII (DILIGENT)</td><td>B</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  <tr><td style="text-align: left; padding-left: 10px;">USHIRIKIANO (COOPERATION)</td><td>B</td></tr>
Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  </table>

Â  Â  Â  Â  <div class="stats-box">
Â  Â  Â  Â  Â  Â  <strong>WASTANI WA JUMLA:</strong> <span id="overallAvg">-</span><br>
Â  Â  Â  Â  Â  Â  <strong>POINTS (BEST 7):</strong> <span id="totalPoints">-</span><br>
Â  Â  Â  Â  Â  Â  <strong>DIVISION:</strong> <span id="division">-</span><br>
Â  Â  Â  Â  Â  Â  <strong>NAFASI:</strong> <span id="rank">...</span> <strong>KATI YA</strong> <span id="totalStuds">...</span>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="grading-key">
Â  Â  Â  Â  <span>A = 75-100 (VIZURI SANA)</span>
Â  Â  Â  Â  <span>B = 65-74 (VIZURI)</span>
Â  Â  Â  Â  <span>C = 45-64 (WASTANI)</span>
Â  Â  Â  Â  <span>D = 30-44 (INARIDHISHA)</span>
Â  Â  Â  Â  <span>F = 0-29 (FELI)</span>
Â  Â  </div>

Â  Â  <div class="footer-sections">
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <p>Maoni ya mwalimu wa darasa:</p>
Â  Â  Â  Â  Â  Â  <div class="sig-box">Sahihi ya Mwalimu wa Darasa</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <p>Maoni ya mkuu wa shule:</p>
Â  Â  Â  Â  Â  Â  <div class="sig-box">Sahihi ya Mkuu wa Shule</div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="parent-section">
Â  Â  Â  Â  <p><strong>MAONI YA MZAZI / MLEZI (PARENT COMMENT):</strong></p>
Â  Â  Â  Â  <div class="comment-box"></div>
Â  Â  Â  Â  <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 11px;">
Â  Â  Â  Â  Â  Â  <span>Sahihi: ...........................</span>
Â  Â  Â  Â  Â  Â  <span>Tarehe: ...........................</span>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<script type="module">
Â  Â  import { db } from "./firebase.js";
Â  Â  import { subjectLists } from "./data.js";
Â  Â  import { doc, getDoc, getDocs, collection, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

Â  Â  async function generateReport() {
Â  Â  Â  Â  const urlParams = new URLSearchParams(window.location.search);
Â  Â  Â  Â  const studentId = urlParams.get('id');
Â  Â  Â  Â  if(!studentId) return;

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  // 1. Fetch Student Header Data
Â  Â  Â  Â  Â  Â  const sSnap = await getDoc(doc(db, "students", studentId));
Â  Â  Â  Â  Â  Â  if(!sSnap.exists()) return;
Â  Â  Â  Â  Â  Â  const student = sSnap.data();
Â  Â  Â  Â  Â  Â  document.getElementById("studentName").innerText = student.name;
Â  Â  Â  Â  Â  Â  document.getElementById("studentClass").innerText = student.cls;

Â  Â  Â  Â  Â  Â  // 2. Fetch Results for this student
Â  Â  Â  Â  Â  Â  const rSnap = await getDocs(query(collection(db, "results"), where("studentId", "==", studentId)));
Â  Â  Â  Â  Â  Â  const myResMap = {};
Â  Â  Â  Â  Â  Â  rSnap.forEach(d => myResMap[d.data().subjectCode] = d.data());

Â  Â  Â  Â  Â  Â  // 3. Fetch All Students/Results for Ranking
Â  Â  Â  Â  Â  Â  const allResSnap = await getDocs(collection(db, "results"));
Â  Â  Â  Â  Â  Â  const allStudSnap = await getDocs(query(collection(db, "students"), where("cls", "==", student.cls)));
Â  Â  Â  Â  Â  Â  document.getElementById("totalStuds").innerText = allStudSnap.size;

Â  Â  Â  Â  Â  Â  const subjects = subjectLists[student.cls] || [];
Â  Â  Â  Â  Â  Â  const tbody = document.getElementById("reportTbody");
Â  Â  Â  Â  Â  Â  tbody.innerHTML = "";
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let sumW = 0, countS = 0, ptsArr = [];

Â  Â  Â  Â  Â  Â  // 4. Calculate Individual Subject Rows
Â  Â  Â  Â  Â  Â  subjects.forEach(sub => {
Â  Â  Â  Â  Â  Â  Â  Â  const res = myResMap[sub.code];
Â  Â  Â  Â  Â  Â  Â  Â  if(res) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Logic: Jaribio = Average of T1, Mid, T2 (filled only)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let jScores = [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(res.test1 && res.test1 !== "") jScores.push(parseFloat(res.test1));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(res.midTerm && res.midTerm !== "") jScores.push(parseFloat(res.midTerm));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(res.test2 && res.test2 !== "") jScores.push(parseFloat(res.test2));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const jaribio = jScores.length > 0 ? (jScores.reduce((a,b)=>a+b,0)/jScores.length) : 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const mtihani = parseFloat(res.exam) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Total = Jaribio Average + Mtihani
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const jumla = jaribio + mtihani;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Wastani = Jumla / 2
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const wastani = (jumla / 2).toFixed(1);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let grade = "F", maoni = "FELI";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const w = parseFloat(wastani);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(w >= 75) { grade="A"; maoni="VIZURI SANA"; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if(w >= 65) { grade="B"; maoni="VIZURI"; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if(w >= 45) { grade="C"; maoni="WASTANI"; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if(w >= 30) { grade="D"; maoni="INARIDHISHA"; }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sumW += w;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  countS++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ptsArr.push({"A":1,"B":2,"C":3,"D":4,"F":5}[grade]);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tbody.innerHTML += `<tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="subject-col">${sub.name}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${jaribio.toFixed(0)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${mtihani}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${jumla.toFixed(0)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${wastani}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${grade}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${maoni}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // 5. Final Stats Calculation (Overall Average, Best 7 Points, Division)
Â  Â  Â  Â  Â  Â  document.getElementById("overallAvg").innerText = countS > 0 ? (sumW / countS).toFixed(1) : "0.0";
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if(countS >= 7) {
Â  Â  Â  Â  Â  Â  Â  Â  ptsArr.sort((a,b)=>a-b);
Â  Â  Â  Â  Â  Â  Â  Â  const b7 = ptsArr.slice(0, 7).reduce((a,b)=>a+b, 0);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("totalPoints").innerText = b7;
Â  Â  Â  Â  Â  Â  Â  Â  let d = "IV";
Â  Â  Â  Â  Â  Â  Â  Â  if(b7 <= 17) d="I"; else if(b7 <= 21) d="II"; else if(b7 <= 25) d="III";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("division").innerText = d;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("totalPoints").innerText = "INC";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("division").innerText = "";
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // 6. Ranking Logic
Â  Â  Â  Â  Â  Â  let rankingData = [];
Â  Â  Â  Â  Â  Â  allStudSnap.forEach(sDoc => {
Â  Â  Â  Â  Â  Â  Â  Â  let sSum = 0, sCount = 0, sPts = [];
Â  Â  Â  Â  Â  Â  Â  Â  allResSnap.forEach(rDoc => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const r = rDoc.data();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(r.studentId === sDoc.id) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Reproduce average logic for each student to rank correctly
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let sjScores = [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(r.test1) sjScores.push(parseFloat(r.test1));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(r.midTerm) sjScores.push(parseFloat(r.midTerm));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(r.test2) sjScores.push(parseFloat(r.test2));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const sj = sjScores.length > 0 ? (sjScores.reduce((a,b)=>a+b,0)/sjScores.length) : 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const sm = parseFloat(r.exam) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const sw = (sj + sm) / 2;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sSum += sw; sCount++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let sg = "F";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(sw >= 75) sg="A"; else if(sw >= 65) sg="B"; else if(sw >= 45) sg="C"; else if(sw >= 30) sg="D";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sPts.push({"A":1,"B":2,"C":3,"D":4,"F":5}[sg]);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  if(sCount >= 7) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sPts.sort((a,b)=>a-b);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  rankingData.push({ id: sDoc.id, pts: sPts.slice(0,7).reduce((a,b)=>a+b,0), avg: sSum/sCount });
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  rankingData.push({ id: sDoc.id, pts: 999, avg: 0 });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  rankingData.sort((a,b) => a.pts - b.pts || b.avg - a.avg);
Â  Â  Â  Â  Â  Â  const myRank = rankingData.findIndex(x => x.id === studentId) + 1;
Â  Â  Â  Â  Â  Â  document.getElementById("rank").innerText = myRank > 0 ? myRank : "-";

Â  Â  Â  Â  } catch (e) {Â 
Â  Â  Â  Â  Â  Â  console.error(e);Â 
Â  Â  Â  Â  Â  Â  document.getElementById("reportTbody").innerHTML = "<tr><td colspan='7'>Matatizo ya kiufundi yamejitokeza.</td></tr>";
Â  Â  Â  Â  }
Â  Â  }
Â  Â  generateReport();
</script>
</body>
</html>

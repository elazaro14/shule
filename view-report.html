<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style.css">
    <title>Ripoti ya Maendeleo - Olmoti</title>
</head>
<body>

<div class="no-print" style="text-align:center; padding: 20px;">
    <button class="btn btn-print" onclick="window.print()">CHAPA RIPOTI (PRINT)</button>
    <button class="btn" onclick="window.history.back()">RUDI NYUMA</button>
</div>

<div class="report-page">
    <div class="header" style="text-align: center; text-transform: uppercase;">
        <h3>OFISI YA WAZIRI MKUU [cite: 22]</h3>
        <h3>TAWALA ZA MIKOA NA SERIKALI ZA MTAA [cite: 23]</h3>
        <h2>HALMASHAURI YA JIJI LA ARUSHA [cite: 23]</h2>
        <h2>SHULE YA SEKONDARI OLMOTI [cite: 23]</h2>
        <p>S.L.P 8249, ARUSHA [cite: 24]</p>
        <h3 style="text-decoration: underline;">TAARIFA YA MAENDELEO YA MWANAFUNZI [cite: 25]</h3>
    </div>

    <div class="student-info" style="display: grid; grid-template-columns: 1fr 1fr; margin-top: 20px;">
        <p><strong>JINA:</strong> <span id="sName">...</span> [cite: 26]</p>
        <p><strong>KIDATO:</strong> <span id="sClass">...</span> [cite: 27]</p>
        <p><strong>MWAKA:</strong> <span>2025</span> [cite: 27]</p>
        <p><strong>MUHULA:</strong> <span>I</span> [cite: 27]</p>
    </div>

    <table>
        <thead>
            <tr>
                <th>SOMO [cite: 27]</th>
                <th>JARIBIO [cite: 27]</th>
                <th>MTIHANI [cite: 27]</th>
                <th>WASTANI [cite: 27]</th>
                <th>DARAJA [cite: 27]</th>
                <th>MAONI [cite: 27]</th>
            </tr>
        </thead>
        <tbody id="reportTbody"></tbody>
    </table>

    <div style="display: flex; justify-content: space-between; margin-top: 20px; font-weight: bold;">
        <div>WASTANI WA JUMLA: <span id="overallAvg">-</span> [cite: 27]</div>
        <div>POINTS: <span id="totalPoints">-</span> [cite: 27]</div>
        <div>DIVISION: <span id="division">-</span> </div>
    </div>

    <div class="footer-sections" style="margin-top: 30px;">
        <p><strong>Maoni ya Mkuu wa Shule:</strong> [cite: 33]</p>
        <p id="headmasterComment" style="border-bottom: 1px dotted #000; padding-bottom: 5px;">...</p>
        <p style="margin-top: 15px;">Shule imefungwa tarehe 05/12/2025 na itafunguliwa tarehe 13/01/2026 </p>
    </div>
</div>

<script type="module">
    import { db } from "./firebase.js";
    import { subjectLists } from "./data.js";
    import { doc, getDoc, getDocs, collection, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    async function load() {
        const id = new URLSearchParams(window.location.search).get('id');
        const sSnap = await getDoc(doc(db, "students", id));
        const student = sSnap.data();
        document.getElementById("sName").innerText = student.name;
        document.getElementById("sClass").innerText = student.cls;

        const rSnap = await getDocs(query(collection(db, "results"), where("studentId", "==", id)));
        const results = {};
        rSnap.forEach(d => results[d.data().subjectCode] = d.data());

        const list = subjectLists[student.cls] || [];
        const tbody = document.getElementById("reportTbody");
        let sum = 0, count = 0, pArr = [];

        list.forEach(sub => {
            const r = results[sub.code];
            if(r) {
                const avg = parseFloat(r.average);
                sum += avg; count++;
                pArr.push({"A":1,"B":2,"C":3,"D":4,"F":5}[r.grade]);
                tbody.innerHTML += `<tr>
                    <td>${sub.name}</td><td>${r.test1||0}</td><td>${r.exam||0}</td>
                    <td>${avg}</td><td>${r.grade}</td><td>${avg >= 30 ? 'PASS' : 'FELI'}</td>
                </tr>`;
            }
        });

        document.getElementById("overallAvg").innerText = (sum/count).toFixed(1);
        const pts = pArr.sort((a,b)=>a-b).slice(0,7).reduce((a,b)=>a+b, 0);
        document.getElementById("totalPoints").innerText = pts;
        
        let div = "IV";
        if(pts <= 17) div = "I"; else if(pts <= 21) div = "II"; else if(pts <= 25) div = "III";
        document.getElementById("division").innerText = div;
    }
    load();
</script>
</body>
</html>

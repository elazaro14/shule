<script type="module">
    import { db } from "./firebase.js";
    import { subjectLists } from "./data.js";
    import { doc, getDoc, getDocs, collection, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    async function generateReport() {
        const urlParams = new URLSearchParams(window.location.search);
        const studentId = urlParams.get('id');
        if(!studentId) return;

        try {
            // 1. Fetch Student Header Data
            const sSnap = await getDoc(doc(db, "students", studentId));
            if(!sSnap.exists()) return;
            const student = sSnap.data();
            document.getElementById("studentName").innerText = student.name;
            document.getElementById("studentClass").innerText = student.cls;

            // 2. Fetch Results for this student
            const rSnap = await getDocs(query(collection(db, "results"), where("studentId", "==", studentId)));
            const myResMap = {};
            rSnap.forEach(d => myResMap[d.data().subjectCode] = d.data());

            // 3. Setup for Classes and Subjects
            const subjects = subjectLists[student.cls] || [];
            const tbody = document.getElementById("reportTbody");
            tbody.innerHTML = "";
            
            let sumW = 0, countS = 0, ptsArr = [];

            // 4. Loop through ALL subjects for this class (ensures table looks complete)
            subjects.forEach(sub => {
                const res = myResMap[sub.code];
                
                // Helper to check if value is actually a number
                const isValid = (val) => val !== "" && val !== null && val !== undefined;

                let jaribioStr = "-", mtihaniStr = "-", jumlaStr = "-", wastaniStr = "-", grade = "-", maoni = "-";

                if(res) {
                    let jScores = [];
                    if(isValid(res.test1)) jScores.push(parseFloat(res.test1));
                    if(isValid(res.midTerm)) jScores.push(parseFloat(res.midTerm));
                    if(isValid(res.test2)) jScores.push(parseFloat(res.test2));
                    
                    const hasJaribio = jScores.length > 0;
                    const jaribio = hasJaribio ? (jScores.reduce((a,b)=>a+b,0)/jScores.length) : 0;
                    const mtihani = isValid(res.exam) ? parseFloat(res.exam) : null;
                    
                    // Display strings
                    if(hasJaribio) jaribioStr = jaribio.toFixed(0);
                    if(mtihani !== null) mtihaniStr = mtihani;

                    // Only calculate Average/Grade if there is at least ONE mark
                    if (hasJaribio || mtihani !== null) {
                        const jumla = (hasJaribio ? jaribio : 0) + (mtihani || 0);
                        const wastani = (jumla / 2).toFixed(1);
                        const w = parseFloat(wastani);

                        jumlaStr = jumla.toFixed(0);
                        wastaniStr = wastani;

                        if(w >= 75) { grade="A"; maoni="VIZURI SANA"; }
                        else if(w >= 65) { grade="B"; maoni="VIZURI"; }
                        else if(w >= 45) { grade="C"; maoni="WASTANI"; }
                        else if(w >= 30) { grade="D"; maoni="INARIDHISHA"; }
                        else { grade="F"; maoni="FELI"; }

                        // Update global stats ONLY for filled subjects
                        sumW += w;
                        countS++;
                        ptsArr.push({"A":1,"B":2,"C":3,"D":4,"F":5}[grade]);
                    }
                }

                // Append the row (either with data or with hyphens)
                tbody.innerHTML += `<tr>
                    <td class="subject-col">${sub.name}</td>
                    <td>${jaribioStr}</td>
                    <td>${mtihaniStr}</td>
                    <td>${jumlaStr}</td>
                    <td>${wastaniStr}</td>
                    <td>${grade}</td>
                    <td>${maoni}</td>
                </tr>`;
            });

            // 5. Final Statistics
            document.getElementById("overallAvg").innerText = countS > 0 ? (sumW / countS).toFixed(1) : "-";
            
            if(countS >= 7) {
                ptsArr.sort((a,b)=>a-b);
                const b7 = ptsArr.slice(0, 7).reduce((a,b)=>a+b, 0);
                document.getElementById("totalPoints").innerText = b7;
                let d = "IV";
                if(b7 <= 17) d="I"; else if(b7 <= 21) d="II"; else if(b7 <= 25) d="III";
                document.getElementById("division").innerText = d;
            } else {
                document.getElementById("totalPoints").innerText = "INC";
                document.getElementById("division").innerText = "-";
            }

            // 6. Basic Ranking Setup
            const allStudSnap = await getDocs(query(collection(db, "students"), where("cls", "==", student.cls)));
            document.getElementById("totalStuds").innerText = allStudSnap.size;
            // (Rank logic stays as your previous indexed version)

        } catch (e) { 
            console.error("Report Generation Error: ", e);
        }
    }
    generateReport();
</script>

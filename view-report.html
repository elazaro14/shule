<script type="module">
    import { db } from "./firebase.js";
    import { subjectLists } from "./data.js";
    import { doc, getDoc, getDocs, collection, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    async function generateReport() {
        const urlParams = new URLSearchParams(window.location.search);
        const studentId = urlParams.get('id');
        if(!studentId) return;

        try {
            const sSnap = await getDoc(doc(db, "students", studentId));
            const student = sSnap.data();
            document.getElementById("studentName").innerText = student.name;
            const currentClass = student.cls;
            document.getElementById("studentClass").innerText = currentClass;

            const rSnap = await getDocs(query(collection(db, "results"), where("studentId", "==", studentId)));
            const myResults = {};
            rSnap.forEach(d => myResults[d.data().subjectCode] = d.data());

            const subjects = subjectLists[currentClass] || [];
            const tbody = document.getElementById("reportTbody");
            tbody.innerHTML = ""; // Clear table
            
            let sumTotalAvg = 0, countSubjects = 0, pointsArr = [];

            subjects.forEach(sub => {
                const res = myResults[sub.code];
                if(res) {
                    // --- NEW LOGIC START ---
                    
                    // 1. Calculate JARIBIO (Average of T1, Mid, T2 only if they exist)
                    let scoresForJaribio = [];
                    if (res.test1 && res.test1 !== "") scoresForJaribio.push(parseFloat(res.test1));
                    if (res.midTerm && res.midTerm !== "") scoresForJaribio.push(parseFloat(res.midTerm));
                    if (res.test2 && res.test2 !== "") scoresForJaribio.push(parseFloat(res.test2));

                    const jaribioValue = scoresForJaribio.length > 0 
                        ? (scoresForJaribio.reduce((a, b) => a + b, 0) / scoresForJaribio.length) 
                        : 0;

                    // 2. Set MTIHANI (Directly from Exam)
                    const mtihaniValue = parseFloat(res.exam) || 0;

                    // 3. Calculate JUMLA (Jaribio Avg + Mtihani)
                    const jumla = jaribioValue + mtihaniValue;

                    // 4. Calculate WASTANI (Final Percentage used for Grading)
                    // Usually (Jumla / 2) if Jaribio is 50 and Mtihani is 50
                    const wastani = (jumla / 2).toFixed(1);

                    // --- NEW LOGIC END ---

                    let grade = "F";
                    const w = parseFloat(wastani);
                    if(w >= 75) grade = "A";
                    else if(w >= 65) grade = "B";
                    else if(w >= 45) grade = "C";
                    else if(w >= 30) grade = "D";

                    sumTotalAvg += w;
                    countSubjects++;
                    pointsArr.push({"A":1,"B":2,"C":3,"D":4,"F":5}[grade]);

                    tbody.innerHTML += `<tr>
                        <td class="subject-col">${sub.name}</td>
                        <td>${jaribioValue.toFixed(0)}</td>
                        <td>${mtihaniValue}</td>
                        <td>${jumla.toFixed(0)}</td>
                        <td>${wastani}</td>
                        <td>${grade}</td>
                        <td>${w >= 30 ? 'PASS' : 'FAIL'}</td>
                    </tr>`;
                }
            });

            // Summary Stats (Best 7 Logic)
            document.getElementById("overallAvg").innerText = countSubjects > 0 ? (sumTotalAvg / countSubjects).toFixed(1) : "0.0";

            if(countSubjects >= 7) {
                pointsArr.sort((a,b) => a-b);
                const b7 = pointsArr.slice(0, 7).reduce((a,b) => a+b, 0);
                document.getElementById("totalPoints").innerText = b7;
                
                let div = "IV";
                if(b7 <= 17) div = "I";
                else if(b7 <= 21) div = "II";
                else if(b7 <= 25) div = "III";
                document.getElementById("division").innerText = div;
            } else {
                document.getElementById("totalPoints").innerText = "INC";
                document.getElementById("division").innerText = "";
            }

            // Ranking
            const allStuds = await getDocs(query(collection(db, "students"), where("cls", "==", currentClass)));
            document.getElementById("totalStuds").innerText = allStuds.size;

        } catch (e) { console.error("Report Generation Error:", e); }
    }
    generateReport();
</script>

<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <title>Results Entry | Shule ERP</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .dashboard-container { max-width: 1100px; margin: auto; padding: 20px; font-family: sans-serif; }
        .form-section { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .controls { display: flex; gap: 15px; align-items: flex-end; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        th { background: #0d6efd; color: white; font-size: 14px; }
        .score-in { width: 60px; padding: 5px; text-align: center; border: 1px solid #ccc; border-radius: 4px; }
        .avg { font-weight: bold; color: #0d6efd; }
        .grade { font-weight: bold; }
        .save-btn { background: #198754; color: white; padding: 15px; width: 100%; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; margin-top: 20px; }
        .save-btn:hover { background: #146c43; }
    </style>
</head>
<body>

<nav><a href="dashboard.html" style="text-decoration:none;">â¬… Back to Dashboard</a></nav>

<div class="dashboard-container">
    <h2>ðŸ“Š Results Entry (Auto-Load & Save)</h2>

    <div class="form-section">
        <div class="controls">
            <div style="flex: 1;">
                <label>Class</label>
                <select id="classSelect" style="width:100%; padding:8px;">
                    <option value="">-- Select Class --</option>
                    <option value="Form 1">Form 1</option>
                    <option value="Form 2">Form 2</option>
                    <option value="Form 3">Form 3</option>
                    <option value="Form 4">Form 4</option>
                </select>
            </div>
            <div style="flex: 1;">
                <label>Subject</label>
                <select id="subjectSelect" style="width:100%; padding:8px;">
                    <option value="">-- Choose Subject --</option>
                </select>
            </div>
            <button id="loadBtn" style="padding: 9px 20px; background: #0d6efd; color: white; border: none; border-radius: 4px; cursor: pointer;">Load Students</button>
        </div>
    </div>

    <div id="entrySection" style="display:none;" class="form-section">
        <h3 id="tableHeader"></h3>
        <table>
            <thead>
                <tr>
                    <th>S/N</th>
                    <th style="text-align:left;">Student Name</th>
                    <th>T1</th>
                    <th>Mid</th>
                    <th>T2</th>
                    <th>Exam</th>
                    <th>Avg</th>
                    <th>Grade</th>
                </tr>
            </thead>
            <tbody id="marksTbody"></tbody>
        </table>
        <button id="saveAllBtn" class="save-btn">SAVE ALL RESULTS</button>
    </div>
</div>



<script type="module">
    import { db } from "./firebase.js";
    import { subjectLists } from "./data.js";
    import { collection, getDocs, query, where, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const classSelect = document.getElementById("classSelect");
    const subjectSelect = document.getElementById("subjectSelect");

    classSelect.onchange = () => {
        const cls = classSelect.value;
        subjectSelect.innerHTML = '<option value="">-- Choose Subject --</option>';
        if (subjectLists[cls]) {
            subjectLists[cls].forEach(sub => {
                subjectSelect.innerHTML += `<option value="${sub.code}">${sub.name}</option>`;
            });
        }
    };

    document.getElementById("loadBtn").onclick = async () => {
        const cls = classSelect.value;
        const subCode = subjectSelect.value;
        if (!cls || !subCode) return alert("Select Class and Subject");

        const q = query(collection(db, "students"), where("cls", "==", cls));
        const snap = await getDocs(q);
        const tbody = document.getElementById("marksTbody");
        tbody.innerHTML = "<tr><td colspan='8'>Loading database...</td></tr>";
        
        let rowsHtml = "";
        let count = 1;

        for (const sDoc of snap.docs) {
            const studentId = sDoc.id;
            const studentName = sDoc.data().name;

            // FETCH EXISTING DATA FOR THIS SUBJECT
            const resSnap = await getDoc(doc(db, "results", `${studentId}_${subCode}`));
            const saved = resSnap.exists() ? resSnap.data() : {};

            rowsHtml += `
                <tr class="student-row" data-id="${studentId}" data-name="${studentName}">
                    <td>${count++}</td>
                    <td style="text-align:left;">${studentName}</td>
                    <td><input type="number" class="score-in t1" value="${saved.test1 ?? ''}"></td>
                    <td><input type="number" class="score-in mid" value="${saved.midTerm ?? ''}"></td>
                    <td><input type="number" class="score-in t2" value="${saved.test2 ?? ''}"></td>
                    <td><input type="number" class="score-in ex" value="${saved.exam ?? ''}"></td>
                    <td class="avg">${saved.average ?? '0'}</td>
                    <td class="grade">${saved.grade ?? '-'}</td>
                </tr>
            `;
        }
        tbody.innerHTML = rowsHtml;
        document.getElementById("tableHeader").innerText = `${subjectSelect.options[subjectSelect.selectedIndex].text} - ${cls}`;
        document.getElementById("entrySection").style.display = "block";
    };

    document.addEventListener('input', (e) => {
        if (e.target.classList.contains('score-in')) {
            const row = e.target.closest('.student-row');
            const t1 = parseFloat(row.querySelector('.t1').value);
            const mid = parseFloat(row.querySelector('.mid').value);
            const t2 = parseFloat(row.querySelector('.t2').value);
            const exam = parseFloat(row.querySelector('.ex').value) || 0;

            // Calculate Dynamic Jaribio (Average of filled tests)
            let tests = [t1, mid, t2].filter(v => !isNaN(v));
            let jaribio = tests.length > 0 ? (tests.reduce((a,b) => a+b, 0) / tests.length) : 0;
            
            // Formula: (Jaribio + Exam) / 2
            let finalAvg = ((jaribio + exam) / 2).toFixed(1);
            row.querySelector('.avg').innerText = finalAvg;

            let g = "F";
            if (finalAvg >= 75) g = "A";
            else if (finalAvg >= 65) g = "B";
            else if (finalAvg >= 45) g = "C";
            else if (finalAvg >= 30) g = "D";
            row.querySelector('.grade').innerText = g;
        }
    });

    document.getElementById("saveAllBtn").onclick = async () => {
        const rows = document.querySelectorAll(".student-row");
        const subCode = subjectSelect.value;
        const cls = classSelect.value;

        try {
            for (let row of rows) {
                const studentId = row.dataset.id;
                const avg = parseFloat(row.querySelector('.avg').innerText);

                if (avg > 0) {
                    await setDoc(doc(db, "results", `${studentId}_${subCode}`), {
                        studentId,
                        studentName: row.dataset.name,
                        class: cls,
                        subjectCode: subCode,
                        test1: parseFloat(row.querySelector('.t1').value) || null,
                        midTerm: parseFloat(row.querySelector('.mid').value) || null,
                        test2: parseFloat(row.querySelector('.t2').value) || null,
                        exam: parseFloat(row.querySelector('.ex').value) || null,
                        average: avg,
                        grade: row.querySelector('.grade').innerText,
                        updatedAt: new Date()
                    });
                }
            }
            alert("All results saved successfully!");
        } catch (err) { alert("Error: " + err.message); }
    };
</script>
</body>
</html>

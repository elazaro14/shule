<script type="module">
    import { db, auth } from "./firebase.js";
    import { collection, getDocs, query, where, setDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { subjectLists } from "./data.js";

    let teacherClass = "";
    let teacherStream = "";
    let userRole = ""; // New variable to track role

    // 1. Authenticate and Get User's Role & Assignment
    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            window.location.href = "index.html";
            return;
        }

        const userSnap = await getDoc(doc(db, "users", user.uid));
        if (userSnap.exists()) {
            const userData = userSnap.data();
            userRole = userData.role; // Store role ('admin' or 'teacher')
            teacherClass = userData.assignedClass || "None";
            teacherStream = userData.assignedStream || "None";

            if (userRole === 'admin') {
                document.getElementById('assignmentInfo').innerHTML = 
                    `<span style="color:red; font-weight:bold;">MODE: ADMIN ACCESS (All Students)</span>`;
                
                // Admins can see all subjects, default to Form 1 list or add a class selector back
                populateSubjects("Form 1"); 
            } else {
                document.getElementById('assignmentInfo').innerText = 
                    `Mwalimu: ${userData.name} | Darasa: ${teacherClass} | Stream: ${teacherStream}`;
                populateSubjects(teacherClass);
            }
        }
    });

    function populateSubjects(cls) {
        const list = (cls.includes("1") || cls.includes("2")) ? subjectLists["Form 1"] : subjectLists["Form 3"];
        subSel.innerHTML = '<option value="">-- Chagua Somo --</option>';
        if(list) {
            list.forEach(s => subSel.innerHTML += `<option value="${s.code}">${s.name}</option>`);
        }
    }

    // 2. Load Students with Admin Override
    loadBtn.onclick = async () => {
        if(!subSel.value) return alert("Chagua Somo kwanza!");
        
        loadBtn.innerText = "Inapakia...";
        
        let qStuds;
        let qRes;

        // --- ADMIN LOGIC ---
        if (userRole === 'admin') {
            // Admin sees EVERY student in the database
            qStuds = collection(db, "students"); 
            qRes = query(collection(db, "results"), where("subjectCode", "==", subSel.value));
        } else {
            // Teacher is restricted to their Class and Stream
            qStuds = query(
                collection(db, "students"), 
                where("cls", "==", teacherClass),
                where("stream", "==", teacherStream)
            );
            qRes = query(
                collection(db, "results"), 
                where("subjectCode", "==", subSel.value),
                where("cls", "==", teacherClass),
                where("stream", "==", teacherStream)
            );
        }
        
        const [studSnap, resSnap] = await Promise.all([getDocs(qStuds), getDocs(qRes)]);
        
        const resultsMap = {};
        resSnap.forEach(d => resultsMap[d.data().studentId] = d.data());

        mTbody.innerHTML = "";
        let i = 1;

        studSnap.forEach(d => {
            const res = resultsMap[d.id] || {};
            const sData = d.data();
            mTbody.innerHTML += `
                <tr class="row" data-id="${d.id}">
                    <td>${i++}</td>
                    <td style="text-align:left;">
                        <b>${sData.name}</b><br>
                        <small>${sData.cls} ${sData.stream || ''}</small>
                    </td>
                    <td><input type="number" class="score-in t1" value="${res.test1 || ''}"></td>
                    <td><input type="number" class="score-in mid" value="${res.midTerm || ''}"></td>
                    <td><input type="number" class="score-in t2" value="${res.test2 || ''}"></td>
                    <td><input type="number" class="score-in ex" value="${res.exam || ''}"></td>
                    <td class="total">${res.total || 0}</td>
                    <td class="avg">${res.average || 0}</td>
                    <td class="grade">${res.grade || '-'}</td>
                </tr>`;
        });
        
        mTable.style.display = "table"; 
        saveBar.style.display = "block";
        loadBtn.innerText = "TAFUTA WANAFUNZI";
    };

    // ... (Keep the rest of your calculation and save logic the same)
</script>

<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <title>Ingiza Alama | Olmoti Secondary</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --nav-blue: #1a237e; --gold: #c5a059; --bg: #f4f7f6; --sidebar-width: 250px; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; display: flex; background: var(--bg); }
        .sidebar { width: var(--sidebar-width); background: var(--nav-blue); color: white; height: 100vh; position: fixed; padding: 20px; box-sizing: border-box; }
        .main-content { margin-left: var(--sidebar-width); padding: 40px; flex-grow: 1; width: calc(100% - var(--sidebar-width)); }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        select, .btn-load { padding: 12px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; }
        .btn-load { background: var(--nav-blue); color: white; border: none; cursor: pointer; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
        th, td { border-bottom: 1px solid #eee; padding: 12px; text-align: center; }
        th { background: #f8f9fa; color: var(--nav-blue); font-size: 12px; }
        .score-in { width: 50px; text-align: center; padding: 5px; border: 1px solid #ddd; border-radius: 4px; }
        .save-bar { position: sticky; bottom: 0; background: white; padding: 20px; border-top: 3px solid var(--nav-blue); text-align: center; display: none; }
        .btn-save { background: #2e7d32; color: white; padding: 15px 60px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>OLMOTI SEC</h2>
        <p><a href="dashboard.html" style="color:white; text-decoration:none;">üè† Dashboard</a></p>
        <p><a href="students-list.html" style="color:white; text-decoration:none;">üë• Wanafunzi</a></p>
    </div>

    <div class="main-content">
        <div class="card">
            <h2 style="color:var(--nav-blue);">Ingiza Alama</h2>
            <div id="statusMsg" style="margin-bottom:10px; font-weight:bold; color:red;">Inakagua ruhusa...</div>
            <select id="subSel"><option value="">-- Chagua Somo --</option></select>
            <button id="loadBtn" class="btn-load">TAFUTA WANAFUNZI</button>
        </div>

        <div class="card" id="tableCard" style="display:none;">
            <table>
                <thead>
                    <tr>
                        <th>S/N</th><th style="text-align:left;">Jina la Mwanafunzi</th>
                        <th>T1</th><th>Mid</th><th>T2</th><th>Ex</th>
                        <th>Total</th><th>Avg</th><th>Grade</th>
                    </tr>
                </thead>
                <tbody id="mTbody"></tbody>
            </table>
        </div>

        <div id="saveBar" class="save-bar">
            <button id="saveBtn" class="btn-save">HIFADHI ALAMA ZOTE</button>
        </div>
    </div>

<script type="module">
    import { db, auth } from "./firebase.js";
    import { collection, getDocs, query, where, setDoc, doc, getDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { subjectLists } from "./data.js";

    let tClass = "";
    let tStream = "";

    onAuthStateChanged(auth, async (user) => {
        if (!user) { window.location.href = "index.html"; return; }
        
        const userSnap = await getDoc(doc(db, "users", user.uid));
        if (userSnap.exists()) {
            const u = userSnap.data();
            // Fallback to "Form 1" and "A" if fields are empty in Firestore
            tClass = u.assignedClass || "Form 1"; 
            tStream = u.assignedStream || "A";
            
            document.getElementById('statusMsg').style.color = "green";
            document.getElementById('statusMsg').innerText = `Mwalimu: ${u.name} | Darasa: ${tClass} | Mkondo: ${tStream}`;
            
            const list = tClass.includes("1") || tClass.includes("2") ? subjectLists["Form 1"] : subjectLists["Form 3"];
            subSel.innerHTML = '<option value="">-- Chagua Somo --</option>';
            list.forEach(s => subSel.innerHTML += `<option value="${s.code}">${s.name}</option>`);
        } else {
            document.getElementById('statusMsg').innerText = "Hitilafu: Akaunti yako haina maelezo ya darasa.";
        }
    });

    loadBtn.onclick = async () => {
        if(!subSel.value) return alert("Tafadhali chagua somo.");
        loadBtn.innerText = "Inatafuta...";
        
        try {
            // FIX: Ensure the fields "cls" and "stream" in your "students" collection match exactly
            const qS = query(
                collection(db, "students"), 
                where("cls", "==", tClass), 
                where("stream", "==", tStream),
                orderBy("name")
            );
            
            const qR = query(collection(db, "results"), where("subjectCode", "==", subSel.value), where("cls", "==", tClass));
            
            const [studSnap, resSnap] = await Promise.all([getDocs(qS), getDocs(qR)]);
            const resMap = {};
            resSnap.forEach(d => resMap[d.data().studentId] = d.data());

            mTbody.innerHTML = "";
            if (studSnap.empty) {
                mTbody.innerHTML = `<tr><td colspan="9">Hakuna wanafunzi waliopatikana kwa ${tClass} - ${tStream}</td></tr>`;
            }

            studSnap.forEach((d, i) => {
                const r = resMap[d.id] || {};
                mTbody.innerHTML += `
                    <tr class="row" data-id="${d.id}">
                        <td>${i+1}</td><td style="text-align:left; font-weight:bold;">${d.data().name}</td>
                        <td><input type="number" class="score-in t1" value="${r.test1||''}"></td>
                        <td><input type="number" class="score-in mid" value="${r.midTerm||''}"></td>
                        <td><input type="number" class="score-in t2" value="${r.test2||''}"></td>
                        <td><input type="number" class="score-in ex" value="${r.exam||''}"></td>
                        <td class="total">${r.total || 0}</td>
                        <td class="avg">${r.average || '-'}</td>
                        <td class="grade">${r.grade || '-'}</td>
                    </tr>`;
            });

            document.getElementById('tableCard').style.display = "block";
            saveBar.style.display = "block";
        } catch (e) {
            console.error(e);
            alert("Hitilafu: Hakikisha Indexing imekamilika kwenye Firebase Console.");
        }
        loadBtn.innerText = "TAFUTA WANAFUNZI";
    };

    // Dynamic Logic for Average and Grades
    document.addEventListener('input', e => {
        if(e.target.classList.contains('score-in')) {
            const row = e.target.closest('tr');
            const inputs = [row.querySelector('.t1').value, row.querySelector('.mid').value, row.querySelector('.t2').value, row.querySelector('.ex').value];
            const filled = inputs.filter(x => x !== "");
            
            if (filled.length === 0) {
                row.querySelector('.avg').innerText = "-";
                row.querySelector('.grade').innerText = "-";
                return;
            }

            const tot = inputs.reduce((a, b) => a + (parseFloat(b) || 0), 0);
            row.querySelector('.total').innerText = tot;
            row.querySelector('.avg').innerText = tot; // Average based on 100% total

            let g = "F";
            if(tot >= 75) g="A"; else if(tot >= 65) g="B"; else if(tot >= 45) g="C"; else if(tot >= 30) g="D";
            row.querySelector('.grade').innerText = g;
            row.querySelector('.grade').style.color = (g === "F") ? "red" : (g === "A" || g === "B") ? "green" : "orange";
        }
    });

    saveBtn.onclick = async () => {
        saveBtn.innerText = "Inahifadhi...";
        const rows = document.querySelectorAll(".row");
        for(let r of rows) {
            const id = r.dataset.id;
            await setDoc(doc(db, "results", `${id}_${subSel.value}`), {
                studentId: id, subjectCode: subSel.value, cls: tClass, stream: tStream,
                test1: r.querySelector('.t1').value, midTerm: r.querySelector('.mid').value,
                test2: r.querySelector('.t2').value, exam: r.querySelector('.ex').value,
                total: r.querySelector('.total').innerText, average: r.querySelector('.avg').innerText, grade: r.querySelector('.grade').innerText
            });
        }
        alert("Zimehifadhiwa!");
        saveBtn.innerText = "HIFADHI ALAMA ZOTE";
    };
</script>
</body>
</html>

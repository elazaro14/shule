import { db } from "./firebase.js";
    import { collection, getDocs, query, where, setDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { subjectLists } from "./data.js";

    // Dynamic Subject Loading based on Class Selection
    classSel.onchange = () => {
        const val = classSel.value;
        const list = (val.includes("1") || val.includes("2")) ? subjectLists["Form 1"] : subjectLists["Form 3"];
        subSel.innerHTML = '<option value="">-- Chagua Somo --</option>';
        if(list) {
            list.forEach(s => subSel.innerHTML += `<option value="${s.code}">${s.name}</option>`);
        }
    };

    loadBtn.onclick = async () => {
        if(!subSel.value) return alert("Chagua Somo kwanza!");
        loadBtn.innerText = "Inapakia...";
        
        const qStuds = query(collection(db, "students"), where("cls", "==", classSel.value));
        const qRes = query(collection(db, "results"), where("subjectCode", "==", subSel.value));
        
        const [studSnap, resSnap] = await Promise.all([getDocs(qStuds), getDocs(qRes)]);
        
        const resultsMap = {};
        resSnap.forEach(d => resultsMap[d.data().studentId] = d.data());

        mTbody.innerHTML = "";
        let i = 1;
        studSnap.forEach(d => {
            const res = resultsMap[d.id] || {};
            
            // Set initial display to '-' if no data exists in database
            const initialAvg = res.average !== undefined ? res.average : "-";
            const initialGrade = res.grade !== undefined ? res.grade : "-";

            mTbody.innerHTML += `
                <tr class="row" data-id="${d.id}">
                    <td>${i++}</td>
                    <td style="text-align:left; font-weight:bold;">${d.data().name}</td>
                    <td><input type="number" class="score-in t1" value="${res.test1 || ''}"></td>
                    <td><input type="number" class="score-in mid" value="${res.midTerm || ''}"></td>
                    <td><input type="number" class="score-in t2" value="${res.test2 || ''}"></td>
                    <td><input type="number" class="score-in ex" value="${res.exam || ''}"></td>
                    <td class="total">${res.total || 0}</td>
                    <td class="avg">${initialAvg}</td>
                    <td class="grade">${initialGrade}</td>
                </tr>`;
        });
        
        mTable.style.display = "table"; 
        saveBar.style.display = "block";
        loadBtn.innerText = "TAFUTA WANAFUNZI";
    };

    // Auto-calculate on Input
    document.addEventListener('input', e => {
        if(e.target.classList.contains('score-in')) {
            const row = e.target.closest('tr');
            
            // Get raw values to check if they are empty
            const v1 = row.querySelector('.t1').value;
            const vM = row.querySelector('.mid').value;
            const v2 = row.querySelector('.t2').value;
            const vE = row.querySelector('.ex').value;

            // Filter out empty strings to count only filled fields
            const filledScores = [v1, vM, v2, vE].filter(v => v !== "");
            
            if (filledScores.length === 0) {
                row.querySelector('.total').innerText = "0";
                row.querySelector('.avg').innerText = "-";
                row.querySelector('.grade').innerText = "-";
                return;
            }

            const t1 = parseFloat(v1) || 0;
            const mid = parseFloat(vM) || 0;
            const t2 = parseFloat(v2) || 0;
            const ex = parseFloat(vE) || 0;
            
            const tot = t1 + mid + t2 + ex;
            const avg = (tot / filledScores.length).toFixed(1);
            
            row.querySelector('.total').innerText = tot;
            row.querySelector('.avg').innerText = avg;
            
            // Grades: A(75-100), B(65-74), C(45-64), D(30-44), F(0-29)
            let g = "F"; 
            if(avg >= 75) g = "A"; 
            else if(avg >= 65) g = "B"; 
            else if(avg >= 45) g = "C"; 
            else if(avg >= 30) g = "D";
            
            row.querySelector('.grade').innerText = g;
        }
    });

    saveBtn.onclick = async () => {
        saveBtn.disabled = true;
        saveBtn.innerText = "Inahifadhi... (Saving...)";
        const rows = document.querySelectorAll(".row");
        
        try {
            for(let r of rows) {
                const id = r.dataset.id;
                await setDoc(doc(db, "results", `${id}_${subSel.value}`), {
                    studentId: id, 
                    subjectCode: subSel.value,
                    test1: r.querySelector('.t1').value, 
                    midTerm: r.querySelector('.mid').value,
                    test2: r.querySelector('.t2').value, 
                    exam: r.querySelector('.ex').value,
                    total: r.querySelector('.total').innerText,
                    average: r.querySelector('.avg').innerText, 
                    grade: r.querySelector('.grade').innerText
                });
            }
            alert("Alama zimehifadhiwa kikamilifu!");
        } catch (err) {
            alert("Hitilafu imetokea wakati wa kuhifadhi.");
            console.error(err);
        } finally {
            saveBtn.disabled = false;
            saveBtn.innerText = "HIFADHI ALAMA ZOTE (SAVE ALL)";
        }
    };

<div class="main-content">
    <div class="registry-container">
        <h2>Student Registry</h2>
        
        <div id="adminControls" style="display:none;" class="add-box">
            <input id="newName" placeholder="Full Name">
            <select id="newSex"><option value="M">Male</option><option value="F">Female</option></select>
            <select id="newClass"><option>Form 1</option><option>Form 2</option><option>Form 3</option><option>Form 4</option></select>
            <button class="btn-save" id="addBtn">Add Student</button>
        </div>

        <table>
            <thead>
                <tr><th>S/N</th><th>Name</th><th>Sex</th><th>Class</th><th id="actionHead" style="display:none;">Actions</th></tr>
            </thead>
            <tbody id="regBody"></tbody>
        </table>
    </div>
</div>

<script type="module">
    import { db, auth } from "./firebase.js";
    import { collection, getDocs, addDoc, doc, getDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    let isAdmin = false;

    onAuthStateChanged(auth, async (user) => {
        if (!user) return window.location.href = "index.html";
        const userSnap = await getDoc(doc(db, "users", user.uid));
        isAdmin = userSnap.data().role === 'admin';
        
        if (isAdmin) {
            document.getElementById('adminControls').style.display = 'block';
            document.getElementById('actionHead').style.display = 'table-cell';
        }
        loadStudents();
    });

    async function loadStudents() {
        const snap = await getDocs(query(collection(db, "students"), orderBy("name")));
        const tbody = document.getElementById('regBody');
        tbody.innerHTML = "";
        
        snap.docs.forEach((d, i) => {
            const s = d.data();
            let actions = isAdmin ? `<td><button onclick="deleteS('${d.id}')" style="color:red; border:none; background:none; cursor:pointer;"><i class="fas fa-trash"></i></button></td>` : "";
            
            tbody.innerHTML += `<tr>
                <td>${i+1}</td>
                <td>${s.name}</td>
                <td>${s.sex}</td>
                <td>${s.cls}</td>
                ${actions}
            </tr>`;
        });
    }

    window.deleteS = async (id) => { if(confirm("Delete student?")) { await deleteDoc(doc(db, "students", id)); loadStudents(); } };
    
    addBtn.onclick = async () => {
        const name = document.getElementById('newName').value;
        if(!name) return;
        await addDoc(collection(db, "students"), {
            name: name,
            sex: document.getElementById('newSex').value,
            cls: document.getElementById('newClass').value,
            stream: "A"
        });
        document.getElementById('newName').value = "";
        loadStudents();
    };
</script>

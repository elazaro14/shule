<script type="module">
    import { db, auth } from "./firebase.js";
    import { collection, query, where, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            // 1. Get the teacher's profile to see their assigned class
            const userRef = doc(db, "users", user.uid);
            const userSnap = await getDoc(userRef);
            
            if (userSnap.exists()) {
                const userData = userSnap.data();
                const role = userData.role;
                const assignedClass = userData.assignedClass;

                // 2. Fetch students based on role
                let q;
                if (role === "admin") {
                    q = collection(db, "students"); // Admins see all
                } else {
                    // Subject and Class teachers only see their assigned class
                    q = query(collection(db, "students"), where("cls", "==", assignedClass));
                }

                loadFilteredStudents(q);
            }
        } else {
            window.location.href = "index.html";
        }
    });

    async function loadFilteredStudents(q) {
        const tbody = document.getElementById("studentTbody");
        try {
            const querySnapshot = await getDocs(q);
            tbody.innerHTML = "";
            
            if (querySnapshot.empty) {
                tbody.innerHTML = "<tr><td colspan='4'>No students found for your assigned class.</td></tr>";
                return;
            }

            querySnapshot.forEach((doc, index) => {
                const s = doc.data();
                tbody.innerHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${s.name}</td>
                        <td><span class="badge-cls">${s.cls}</span></td>
                        <td>
                            <a href="attendance.html?id=${doc.id}" class="action-btn btn-view">ATTENDANCE</a>
                        </td>
                    </tr>`;
            });
        } catch (error) {
            console.error("Error:", error);
            tbody.innerHTML = "<tr><td colspan='4'>Access Denied or Connection Error.</td></tr>";
        }
    }
</script>

<script type="module">
    import { db, auth } from "./firebase.js";
    import { collection, getDocs, addDoc, deleteDoc, doc, query, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // 1. ROLE-BASED ACCESS CONTROL
    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            window.location.href = "index.html";
            return;
        }

        // Fetch user data to check role
        const userSnap = await getDoc(doc(db, "users", user.uid));
        
        if (userSnap.exists()) {
            const userData = userSnap.data();
            const role = userData.role; // Assuming you have a 'role' field

            // Only allow 'admin' or 'academic'
            if (role === "admin" || role === "academic") {
                console.log("Access Granted: " + role);
                loadStuds(); // Load the list if authorized
            } else {
                alert("Huna ruhusa ya kuingia hapa. Ukurasa huu ni kwa ajili ya Admin na Academic Pekee.");
                window.location.href = "dashboard.html";
            }
        } else {
            window.location.href = "index.html";
        }
    });

    // 2. Load Students (Wrapped in a function called above)
    async function loadStuds() {
        const tbody = document.getElementById('sTable');
        try {
            const snap = await getDocs(query(collection(db, "students"), orderBy("name")));
            tbody.innerHTML = "";
            let i = 1;
            snap.forEach(d => {
                const s = d.data();
                tbody.innerHTML += `
                    <tr>
                        <td>${i++}</td>
                        <td><b>${s.name}</b></td>
                        <td>${s.sex}</td>
                        <td>${s.cls}</td>
                        <td>${s.stream}</td>
                        <td>
                            <button class="btn-del" onclick="delStud('${d.id}')">
                                <i class="fas fa-trash"></i> Futa
                            </button>
                        </td>
                    </tr>`;
            });
        } catch (e) {
            console.error("Error loading students: ", e);
        }
    }

    // 3. Add Student Logic... (rest of your code remains the same)
</script>
